---
import "../styles/global.css";
import { getServerSession } from "../lib/auth";

const currentPath = Astro.url.pathname;
const { user } = await getServerSession(Astro.request);

const userWithRole = user as { email?: string; role?: string; user_role?: string } | null;
const userRole = userWithRole?.role || userWithRole?.user_role;
const isFreeUser = userWithRole && userRole !== "admin" && userRole !== "premium";

const isActive = (href: string) =>
  currentPath === href || currentPath.startsWith(`${href}/`);
---

<!-- ================= DESKTOP NAV ================= -->
<nav class="hidden sm:block sticky top-0 z-50 bg-white border-b border-gray-200">
  <div class="max-w-5xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">

    <!-- Left navigation -->
    <ul class="flex items-center gap-4">
      <li>
        <a
          href="/planning"
          class={`text-sm font-medium px-3 py-2 rounded-lg ${
            isActive("/planning")
              ? "bg-sage-100 text-sage-700"
              : "text-gray-700 hover:bg-gray-100"
          }`}
        >
          Planning
        </a>
      </li>

      <li>
        <a
          href="/recipes"
          class={`text-sm font-medium px-3 py-2 rounded-lg ${
            isActive("/recipes")
              ? "bg-sage-100 text-sage-700"
              : "text-gray-700 hover:bg-gray-100"
          }`}
        >
          Recettes
        </a>
      </li>

      <li>
        <a
          href="/shoppingList"
          class={`text-sm font-medium px-3 py-2 rounded-lg ${
            isActive("/shoppingList")
              ? "bg-sage-100 text-sage-700"
              : "text-gray-700 hover:bg-gray-100"
          }`}
        >
          Courses
        </a>
      </li>

      {(userRole === "premium" || userRole === "admin") && (
        <li>
          <a
            href="/reception"
            class={`text-sm font-medium px-3 py-2 rounded-lg ${
              isActive("/reception")
                ? "bg-sage-100 text-sage-700"
                : "text-gray-700 hover:bg-gray-100"
            }`}
          >
            RÃ©ception
          </a>
        </li>
      )}
    </ul>

    <!-- Right actions -->
    <div class="flex items-center gap-3">
      {isFreeUser && (
        <a
          href="/premium"
          class="px-4 py-2 rounded-lg text-sm font-medium bg-sage-100 text-sage-700 hover:bg-sage-200 transition"
        >
          Passer Ã  Premium
        </a>
      )}

      {userWithRole && (
        <div class="relative">
          <button
            id="desktop-user-menu-button"
            class="px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100"
          >
            Mon compte
          </button>

          <div
            id="desktop-user-menu-dropdown"
            class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden"
          >
            <div class="px-4 py-3 border-b text-sm text-gray-600">
              {userWithRole.email}
            </div>

            <a href="/account" class="block px-4 py-2 text-sm hover:bg-gray-50">
              Mon profil
            </a>

            <form method="post" action="/api/auth/logout">
              <button
                type="submit"
                class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50"
              >
                DÃ©connexion
              </button>
            </form>
          </div>
        </div>
      )}
    </div>
  </div>
</nav>

<!-- ================= MOBILE TOP (ACCOUNT) ================= -->
{userWithRole && (
  <div class="sm:hidden fixed top-3 right-3 z-50">
    <button
      id="mobile-user-button"
      class="w-11 h-11 rounded-xl bg-white border border-gray-300 shadow flex items-center justify-center"
    >
      ðŸ‘¤
    </button>

    <div
      id="mobile-user-dropdown"
      class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden"
    >
      {isFreeUser && (
        <a
          href="/premium"
          class="block px-4 py-3 text-sm text-sage-700 bg-sage-50"
        >
          Passer Ã  Premium
        </a>
      )}

      <a href="/account" class="block px-4 py-2 text-sm hover:bg-gray-50">
        Mon profil
      </a>

      <form method="post" action="/api/auth/logout">
        <button
          type="submit"
          class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50"
        >
          DÃ©connexion
        </button>
      </form>
    </div>
  </div>
)}

<!-- ================= MOBILE BOTTOM NAV ================= -->
<nav class="sm:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
  <ul class="flex justify-around h-16">

    <!-- Planning -->
    <li class="flex-1">
      <a href="/planning" class={`flex flex-col items-center justify-center h-full text-xs ${
        isActive("/planning") ? "text-sage-600" : "text-gray-500"
      }`}>
        <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M8 7V3m8 4V3M3 9h18M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>        
        Planning
      </a>
    </li>

    <!-- Recettes -->
    <li class="flex-1">
      <a href="/recipes" class={`flex flex-col items-center justify-center h-full text-xs ${
        isActive("/recipes") ? "text-sage-600" : "text-gray-500"
      }`}>
        <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M12 6c-1.5-1-3.5-1.5-5.5-1.5S3 5 3 6.5v11
               c0-1.5 2-2.5 4.5-2.5s4 .5 5.5 1.5
               c1.5-1 3.5-1.5 5.5-1.5s4.5 1 4.5 2.5v-11
               c0-1.5-2-2.5-4.5-2.5S13.5 5 12 6z" />
        </svg>        
        Recettes
      </a>
    </li>

    <!-- Courses -->
    <li class="flex-1">
      <a href="/shoppingList" class={`flex flex-col items-center justify-center h-full text-xs ${
        isActive("/shoppingList") ? "text-sage-600" : "text-gray-500"
      }`}>
        <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M3 3h2l.4 2M7 13h10l4-8H5.4
               M7 13L5.4 5M7 13l-2 9m12-9l2 9
               M9 21a1 1 0 100-2 1 1 0 000 2zm8 0a1 1 0 100-2 1 1 0 000 2z" />
        </svg>        
        Courses
      </a>
    </li>

  </ul>
</nav>

<script>
  const toggle = (btn: HTMLElement | null, menu: HTMLElement | null) => {
    if (!btn || !menu) return;
    btn.addEventListener("click", (e: MouseEvent) => {
      e.stopPropagation();
      menu.classList.toggle("hidden");
    });
    document.addEventListener("click", () => menu.classList.add("hidden"));
  };

  toggle(
    document.getElementById("desktop-user-menu-button"),
    document.getElementById("desktop-user-menu-dropdown")
  );

  toggle(
    document.getElementById("mobile-user-button"),
    document.getElementById("mobile-user-dropdown")
  );
</script>

<style>
  @media (max-width: 639px) {
    body {
      padding-bottom: 64px;
    }
  }
</style>
