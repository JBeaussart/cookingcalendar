---
import "../styles/global.css";
import { getServerSession } from "../lib/auth";

const currentPath = Astro.url.pathname;
const { user } = await getServerSession(Astro.request);

const userWithRole = user as { email?: string; role?: string; user_role?: string } | null;
const userRole = userWithRole?.role || userWithRole?.user_role;
const isFreeUser = userWithRole && userRole !== "admin" && userRole !== "premium";

const isActive = (href: string) =>
  currentPath === href || currentPath.startsWith(`${href}/`);
---

<!-- ================= DESKTOP NAV ================= -->
<nav class="hidden sm:block sticky top-0 z-50 bg-white border-b border-gray-200">
  <div class="max-w-5xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">

    <!-- LEFT NAV -->
    <ul class="flex items-center gap-4">

      <!-- Planning -->
      <li>
        <a
          href="/planning"
          class={`flex items-center gap-2 text-sm font-medium px-3 py-2 rounded-lg ${
            isActive("/planning")
              ? "bg-sage-100 text-sage-700"
              : "text-gray-700 hover:bg-gray-100"
          }`}
        >
          üóìÔ∏è
          <span>Planning</span>
        </a>
      </li>

      <!-- Recettes -->
      <li>
        <a
          href="/recipes"
          class={`flex items-center gap-2 text-sm font-medium px-3 py-2 rounded-lg ${
            isActive("/recipes")
              ? "bg-sage-100 text-sage-700"
              : "text-gray-700 hover:bg-gray-100"
          }`}
        >
          üìñ
          <span>Recettes</span>
        </a>
      </li>

      <!-- Courses -->
      <li>
        <a
          href="/shoppingList"
          class={`flex items-center gap-2 text-sm font-medium px-3 py-2 rounded-lg ${
            isActive("/shoppingList")
              ? "bg-sage-100 text-sage-700"
              : "text-gray-700 hover:bg-gray-100"
          }`}
        >
          üõí
          <span>Courses</span>
        </a>
      </li>

      <!-- R√©ception (premium/admin uniquement) -->
      {(userRole === "premium" || userRole === "admin") && (
        <li>
          <a
            href="/reception"
            class={`flex items-center gap-2 text-sm font-medium px-3 py-2 rounded-lg ${
              isActive("/reception")
                ? "bg-sage-100 text-sage-700"
                : "text-gray-700 hover:bg-gray-100"
            }`}
          >
            üéâ
            <span>R√©ception</span>
          </a>
        </li>
      )}

    </ul>

    <!-- RIGHT ACTIONS -->
    <div class="flex items-center gap-3">

      {isFreeUser && (
        <a
          href="/premium"
          class="px-4 py-2 rounded-lg text-sm font-medium bg-sage-100 text-sage-700 hover:bg-sage-200 transition"
        >
          Passer √† Premium
        </a>
      )}

      {userWithRole && (
        <div class="relative">
          <button
            id="desktop-user-menu-button"
            class="px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100"
          >
            Mon compte
          </button>

          <div
            id="desktop-user-menu-dropdown"
            class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden"
          >
            <div class="px-4 py-3 border-b text-sm text-gray-600">
              {userWithRole.email}
            </div>

            <a href="/account" class="block px-4 py-2 text-sm hover:bg-gray-50">
              Mon profil
            </a>

            <form method="post" action="/api/auth/logout">
              <button
                type="submit"
                class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50"
              >
                D√©connexion
              </button>
            </form>
          </div>
        </div>
      )}

    </div>
  </div>
</nav>

<!-- ================= MOBILE BOTTOM NAV (SVG ORIGINAUX) ================= -->
<nav class="sm:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
  <ul class="flex justify-around h-16">

    <!-- Planning -->
    <li class="flex-1">
      <a
        href="/planning"
        class={`flex flex-col items-center justify-center h-full text-xs ${
          isActive("/planning") ? "text-sage-600" : "text-gray-500"
        }`}
      >
        <svg
          class="w-5 h-5 mb-1"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M8 7V3m8 4V3M3 9h18M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        Planning
      </a>
    </li>

    <!-- Recettes -->
    <li class="flex-1">
      <a
        href="/recipes"
        class={`flex flex-col items-center justify-center h-full text-xs ${
          isActive("/recipes") ? "text-sage-600" : "text-gray-500"
        }`}
      >
        <svg
          class="w-5 h-5 mb-1"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
          <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
        </svg>
        Recettes
      </a>
    </li>

    <!-- Courses -->
    <li class="flex-1">
      <a
        href="/shoppingList"
        class={`flex flex-col items-center justify-center h-full text-xs ${
          isActive("/shoppingList") ? "text-sage-600" : "text-gray-500"
        }`}
      >
        <svg
          class="w-5 h-5 mb-1"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="9" cy="21" r="1" />
          <circle cx="20" cy="21" r="1" />
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
        </svg>
        Courses
      </a>
    </li>

    <!-- R√©ception (premium / admin uniquement) -->
    {(userRole === "premium" || userRole === "admin") && (
      <li class="flex-1">
        <a
          href="/reception"
          class={`flex flex-col items-center justify-center h-full text-xs ${
            isActive("/reception") ? "text-sage-600" : "text-gray-500"
          }`}
        >
          <svg
            class="w-5 h-5 mb-1"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="9" cy="7" r="4" />
            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
          </svg>
          R√©ception
        </a>
      </li>
    )}

  </ul>
</nav>


<style>
  @media (max-width: 639px) {
    body {
      padding-bottom: 64px;
    }
  }
</style>
