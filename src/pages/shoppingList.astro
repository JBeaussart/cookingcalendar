---
import Layout from "../layouts/Layout.astro";
---
<Layout title="Liste de courses">
  <div class="mx-auto max-w-3xl px-4 py-6">
    <div class="mb-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold">ðŸ›’ Liste de courses</h1>
      <button id="btnReload" class="rounded bg-gray-700 px-3 py-2 text-sm text-white">Recharger</button>
    </div>

    <ul id="list" class="divide-y divide-gray-200 rounded border bg-white"></ul>
    <p id="status" class="mt-3 text-sm text-gray-500"></p>
  </div>

  <script type="module">
    const listEl = document.getElementById("list");
    const statusEl = document.getElementById("status");
    const btnReload = document.getElementById("btnReload");

    let items = []; // [{ item, quantity?, unit?, checked? }]

    function render() {
      listEl.innerHTML = "";
      if (!Array.isArray(items) || items.length === 0) {
        listEl.innerHTML = `<li class="px-4 py-3 text-sm text-gray-600">Aucune recette planifiÃ©e.</li>`;
        return;
      }
      items.forEach((row) => {
        const li = document.createElement("li");
        li.className = "flex items-center gap-3 px-4 py-3";
        const txt = (typeof row.quantity === "number" && !isNaN(row.quantity))
          ? `${row.item} : ${row.quantity}${row.unit ? " " + row.unit : ""}`
          : row.item;
        li.innerHTML = `
          <input type="checkbox" class="h-5 w-5 text-green-600" ${row.checked ? "checked" : ""} disabled>
          <span>${txt}</span>
        `;
        listEl.appendChild(li);
      });
    }

    async function load() {
      statusEl.textContent = "Chargementâ€¦";
      try {
        const r = await fetch("/api/save-shopping-totals", { method: "GET" });
        const j = await r.json();
        items = Array.isArray(j.items) ? j.items : [];
        statusEl.textContent = "OK";
        render();
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Erreur de chargement";
      }
    }

    btnReload.addEventListener("click", load);
    await load();
  </script>
</Layout>
