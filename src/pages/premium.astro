---
import Layout from "../layouts/Layout.astro";
import { getServerSession } from "../lib/auth";

const { user } = await getServerSession(Astro.request);

if (!user) {
  return Astro.redirect("/login", 302);
}

type UserWithRole = {
  role?: string;
  user_role?: string;
};

const userWithRole = user as UserWithRole;
const userRole = userWithRole.role || userWithRole.user_role;

if (userRole === "premium" || userRole === "admin") {
  return Astro.redirect("/account", 302);
}
---

<Layout title="Passer Ã  Premium">
  <div class="min-h-screen bg-sage-50 py-12 sm:py-16">
    <div class="max-w-5xl mx-auto px-4">

      <!-- ================= HERO ================= -->
      <section class="text-center mb-10 sm:mb-12">
        <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-sage-100 mb-4">
          <span class="text-3xl">â­</span>
        </div>

        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-3">
          Passez Ã  la version Premium
        </h1>

        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          Continuez Ã  organiser vos repas sans limite  
          et gagnez encore plus de temps au quotidien.
        </p>
      </section>

      <!-- ================= BÃ‰NÃ‰FICES ================= -->

      <!-- Desktop -->
      <section class="hidden md:grid grid-cols-3 gap-6 mb-12">

        <div class="bg-white p-6 rounded-2xl border border-sage-100 text-center">
          <span class="text-3xl">ğŸ“–</span>
          <h3 class="font-semibold mt-3 mb-1">
            Recettes illimitÃ©es
          </h3>
          <p class="text-sm text-gray-600">
            Gardez toutes vos recettes sans jamais en supprimer.
          </p>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-sage-100 text-center">
          <span class="text-3xl">ğŸ‰</span>
          <h3 class="font-semibold mt-3 mb-1">
            Repas de rÃ©ception
          </h3>
          <p class="text-sm text-gray-600">
            Anniversaires, repas de famille, invitations.
          </p>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-sage-100 text-center">
          <span class="text-3xl">ğŸ“„</span>
          <h3 class="font-semibold mt-3 mb-1">
            Export PDF
          </h3>
          <p class="text-sm text-gray-600">
            Imprimez ou partagez vos recettes facilement.
          </p>
        </div>

      </section>

      <!-- Mobile -->
      <section class="md:hidden space-y-3 mb-8">

        <div class="bg-white p-4 rounded-xl border border-sage-100 flex gap-3">
          <span class="text-2xl">ğŸ“–</span>
          <div>
            <p class="font-medium">Recettes illimitÃ©es</p>
            <p class="text-sm text-gray-600">
              Plus jamais besoin de supprimer une recette.
            </p>
          </div>
        </div>

        <div class="bg-white p-4 rounded-xl border border-sage-100 flex gap-3">
          <span class="text-2xl">ğŸ‰</span>
          <div>
            <p class="font-medium">Repas de rÃ©ception</p>
            <p class="text-sm text-gray-600">
              Repas de famille, anniversaires, invitÃ©s.
            </p>
          </div>
        </div>

        <div class="bg-white p-4 rounded-xl border border-sage-100 flex gap-3">
          <span class="text-2xl">ğŸ“„</span>
          <div>
            <p class="font-medium">Export PDF</p>
            <p class="text-sm text-gray-600">
              Imprimez ou partagez vos recettes.
            </p>
          </div>
        </div>

      </section>

      <!-- ================= CARTE PREMIUM ================= -->
      <section class="bg-white rounded-3xl shadow-lg border border-sage-200 p-6 sm:p-8 mb-10 max-w-md mx-auto">

        <div class="text-center mb-6">
          <span class="inline-block bg-sage-100 text-sage-700 text-xs font-semibold px-4 py-1 rounded-full mb-3">
            Le plus choisi par les familles
          </span>

          <h2 class="text-2xl font-bold mb-2">
            Premium
          </h2>

          <div class="text-5xl font-bold text-gray-900 mb-1">
            2,99 â‚¬
          </div>
          <p class="text-sm text-gray-500">
            par mois Â· sans engagement
          </p>
        </div>

        <ul class="space-y-2 text-sm text-gray-700 mb-6 max-w-sm mx-auto">
          <li>âœ” Tout le plan gratuit</li>
          <li>âœ” Recettes illimitÃ©es</li>
          <li>âœ” Menus de rÃ©ception</li>
          <li>âœ” Export PDF</li>
          <li>âœ” Support prioritaire</li>
        </ul>

        <button
          id="upgrade-button"
          class="w-full py-4 bg-sage-600 text-white text-lg font-semibold rounded-xl shadow-md active:scale-[0.98] transition"
        >
          Passer Ã  Premium
        </button>

        <p class="text-center text-sm text-gray-500 mt-4">
          Paiement sÃ©curisÃ© Â· Sans engagement Â· Annulation Ã  tout moment
        </p>
      </section>

      <!-- ================= FEEDBACK ================= -->
      <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"></div>
      <div id="success-message" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-4"></div>

    </div>
  </div>
</Layout>

<script>
  const upgradeButton = document.getElementById("upgrade-button") as HTMLButtonElement | null;
  const errorDiv = document.getElementById("error-message");
  const successDiv = document.getElementById("success-message");

  if (upgradeButton && errorDiv && successDiv) {
    upgradeButton.addEventListener("click", async () => {
      errorDiv.classList.add("hidden");
      successDiv.classList.add("hidden");

      upgradeButton.disabled = true;
      const originalText = upgradeButton.textContent;
      upgradeButton.textContent = "Activation en coursâ€¦";

      try {
        const res = await fetch("/api/upgrade-premium", { method: "POST" });
        const data = await res.json();

        if (!res.ok) {
          errorDiv.textContent = data.error || "Une erreur est survenue.";
          errorDiv.classList.remove("hidden");
        } else {
          successDiv.textContent = "Bienvenue dans Premium ğŸ‰";
          successDiv.classList.remove("hidden");
          setTimeout(() => window.location.href = "/account", 1600);
        }
      } catch {
        errorDiv.textContent = "Une erreur est survenue. Veuillez rÃ©essayer.";
        errorDiv.classList.remove("hidden");
      } finally {
        upgradeButton.disabled = false;
        if (originalText) {
          upgradeButton.textContent = originalText;
        }
      }
    });
  }
</script>
