---
// src/pages/recipes/[id].astro
import Layout from "../../layouts/Layout.astro";

import { getServerSession } from "../../lib/auth";
import { supabase } from "../../supabase";

// V√©rifier si l'utilisateur est connect√© et r√©cup√©rer le client Supabase en un seul appel
const { user, supabase: authSupabase } = await getServerSession(Astro.request);

// Si non connect√©, rediriger vers la page d'accueil
if (!user) {
  return Astro.redirect("/", 302);
}

// Type assertion pour user
type UserWithRole = {
  id: string;
  role?: string;
  user_role?: string;
};
const userWithRole = user as UserWithRole;
const userId = userWithRole.id;

// Type assertion pour le client Supabase
const authenticatedSupabase = (authSupabase || supabase) as typeof supabase;

const { id } = Astro.params;

const recipe = await (async () => {
  try {
    const { data, error } = await authenticatedSupabase
      .from('recipes')
      .select('*')
      .eq('id', id)
      .eq('user_id', userId) // S'assurer que l'utilisateur ne peut voir que ses propres recettes
      .single();
    
    if (error || !data) return null;
    return data;
  } catch {
    return null;
  }
})();

const DEFAULT_IMG = "/images/default-recipe.jpg";
---

<Layout title={recipe?.title || "Recette"} user={user}>
    <div
      class="min-h-screen bg-gradient-to-br from-sage-50/30 via-sage-50/20 to-slate-50 pb-20"
    >
      <div class="mx-auto max-w-4xl px-4 py-8 sm:py-12">
        {
          recipe ? (
            <>
              {/* Navigation & Actions */}
              <div class="mb-6 flex items-center justify-between">
                <a
                  href="/recipes"
                  class="inline-flex items-center gap-2 rounded-xl bg-white px-4 py-2 text-sm font-medium text-slate-600 shadow-sm ring-1 ring-slate-200 transition hover:bg-sage-50 hover:text-sage-300"
                >
                  <svg
                    class="h-4 w-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10 19l-7-7m0 0l7-7m-7 7h18"
                    />
                  </svg>
                  Retour
                </a>

                <div class="flex items-center gap-2">
                  <a
                    href={`/recipes/${recipe.id}/edit`}
                    class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white text-slate-600 shadow-sm ring-1 ring-slate-200 transition hover:bg-sage-50 hover:text-sage-300"
                    title="Modifier"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                      />
                    </svg>
                  </a>
                  <button
                    id="deleteRecipe"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white text-rose-600 shadow-sm ring-1 ring-slate-200 transition hover:bg-rose-50 hover:text-rose-700"
                    title="Supprimer"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m1 0H8m8 0l-1-3H9L8 7"
                      />
                    </svg>
                  </button>
                </div>
              </div>

              {/* Main Card */}
              <div class="overflow-hidden rounded-3xl bg-white shadow-xl shadow-slate-200/50 ring-1 ring-slate-100">
                {/* Image Header */}
                <div class="relative h-64 sm:h-80 w-full">
                  <img
                    src={recipe.image || DEFAULT_IMG}
                    alt={recipe.title}
                    loading="eager"
                    decoding="async"
                    class="h-full w-full object-cover"
                    onerror={`this.src='${DEFAULT_IMG}'`}
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent" />

                  {/* Badges (Top Left) */}
                  <div class="absolute top-4 left-4 flex flex-wrap gap-2">
                    {recipe.maman && (
                      <span class="inline-flex items-center gap-1 rounded-full bg-pink-500/90 backdrop-blur-sm px-3 py-1 text-xs font-bold text-white shadow-sm">
                        <svg class="w-3 h-3" viewBox="0 0 512 512" fill="currentColor"><path d="M226.5 92.9c14.3 42.9-.3 86.2-32.6 96.8s-70.1-15.6-84.4-58.5.3-86.2 32.6-96.8 70.1 15.6 84.4 58.5zM100.4 198.6c18.9 32.4 14.3 70.1-10.2 84.1s-59.7-.9-78.5-33.3S-2.7 179.3 21.8 165.3s59.7.9 78.6 33.3zM69.2 401.2C121.6 259.9 214.7 224 256 224s134.4 35.9 186.8 177.2c3.6 9.7 5.2 20.1 5.2 30.5v1.6c0 25.8-20.9 46.7-46.7 46.7-11.5 0-22.9-1.4-34-4.2l-88-22c-15.3-3.8-31.3-3.8-46.6 0l-88 22c-11.1 2.8-22.5 4.2-34 4.2-25.8 0-46.7-20.9-46.7-46.7v-1.6c0-10.4 1.6-20.8 5.2-30.5zM324.5 92.9c14.3-42.9 51.7-73.1 84.4-58.5s46.9 53.9 32.6 96.8-51.7 73.1-84.4 58.5-46.9-53.9-32.6-96.8zM400.1 165.3c24.5 14 29.1 51.7 10.2 84.1s-54 48.2-78.5 33.3-29.1-51.7-10.2-84.1 54-48.2 78.5-33.3z"/></svg>
                        Recette de maman
                      </span>
                    )}
                    <span
                      class={`inline-flex items-center rounded-full px-3 py-1 text-xs font-bold text-white shadow-sm backdrop-blur-sm ${recipe.salt ? "bg-sage-300/90" : "bg-sage-500/90"}`}
                    >
                      {recipe.salt ? "Sal√©" : "Sucr√©"}
                    </span>
                  </div>

                  {/* Title Overlay (Bottom) */}
                  <div class="absolute bottom-0 left-0 right-0 p-6 sm:p-8">
                    <h1 class="text-3xl sm:text-4xl font-bold text-white drop-shadow-md">
                      {recipe.title}
                    </h1>
                  </div>

                  {/* Add Button Container (floating) */}
                  <div id="addBtnContainer" class="absolute right-4 top-4" />
                </div>

                {/* Content Grid */}
                <div class="grid gap-12 p-6 sm:p-10 md:grid-cols-[1fr_1.5fr]">
                  {/* Ingredients */}
                  <section>
                    <h2 class="mb-6 flex items-center gap-3 text-lg font-bold text-slate-900">
                      <span class="flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-600">
                        üßÇ
                      </span>
                      Ingr√©dients
                    </h2>
                    <ul class="space-y-3 pl-2">
                      {recipe.ingredients.map((i: string | { item: string; quantity?: number | string; unit?: string }) => (
                        <li class="flex items-start gap-3 text-slate-700">
                          <div class="mt-1.5 h-1.5 w-1.5 flex-none rounded-full bg-slate-400" />
                          <span class="text-sm font-medium leading-relaxed">
                            {typeof i === "object" && i.quantity
                              ? `${i.item}: ${i.quantity} ${i.unit || ""}`
                              : typeof i === "object"
                                ? i.item
                                : i}
                          </span>
                        </li>
                      ))}
                    </ul>
                  </section>

                  {/* Preparation */}
                  <section>
                    <h2 class="mb-6 flex items-center gap-3 text-lg font-bold text-slate-900">
                      <span class="flex h-8 w-8 items-center justify-center rounded-lg bg-white shadow-sm ring-1 ring-slate-200 text-slate-600">
                        üç≥
                      </span>
                      Pr√©paration
                    </h2>
                    <div class="space-y-8">
                      {recipe.steps.map((s: string, idx: number) => (
                        <div class="relative pl-8">
                          {/* Connecting Line (except for last item) */}
                          {idx !== recipe.steps.length - 1 && (
                            <div class="absolute left-[11px] top-8 bottom-[-32px] w-px bg-slate-200" />
                          )}

                          <span class="absolute left-0 top-0 flex h-6 w-6 items-center justify-center rounded-full bg-slate-100 text-xs font-bold text-slate-600 ring-4 ring-white">
                            {idx + 1}
                          </span>
                          <p class="text-slate-600 leading-relaxed text-base">
                            {s}
                          </p>
                        </div>
                      ))}
                    </div>
                  </section>
                </div>
              </div>

              <div id="recipe-data" data-id={recipe.id} class="hidden" />
            </>
          ) : (
            <div class="flex min-h-[50vh] flex-col items-center justify-center text-center">
              <div class="mb-4 rounded-full bg-slate-100 p-4">
                <svg
                  class="h-8 w-8 text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
              <h2 class="text-xl font-semibold text-slate-900">
                Recette introuvable
              </h2>
              <p class="mt-2 text-slate-500">
                Cette recette n'existe pas ou a √©t√© supprim√©e.
              </p>
              <a
                href="/recipes"
                class="mt-6 inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-sage-300 to-sage-500 px-6 py-3 text-sm font-bold text-white shadow-lg shadow-sage-300/30 transition hover:from-sage-300 hover:to-sage-600 hover:scale-105"
              >
                Retour aux recettes
              </a>
            </div>
          )
        }
      </div>
    </div>

    <script is:inline>
      document.addEventListener("astro:page-load", () => {
        // + depuis le planning
        const params = new URLSearchParams(window.location.search);
        const dayParam = (params.get("day") || "").toLowerCase();
        const addBtnContainer = document.getElementById("addBtnContainer");
        const dataEl = document.getElementById("recipe-data");
        const recipeId = dataEl ? dataEl.getAttribute("data-id") : null;

        if (dayParam && recipeId) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/90 text-green-600 ring-1 ring-green-200 shadow hover:bg-white hover:text-green-700 hover:ring-green-300 transition";
          btn.title = `Ajouter au ${dayParam}`;
          btn.setAttribute(
            "aria-label",
            `Ajouter cette recette au ${dayParam}`,
          );
          btn.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16M20 12H4" /></svg>';
          btn.addEventListener("click", async () => {
            try {
              const res = await fetch("/api/assign-recipe", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ day: dayParam, id: recipeId }),
              });
              if (!res.ok) throw new Error("assign failed");
              window.location.href = "/";
            } catch (err) {
              console.error("Assignation √©chou√©e:", err);
              alert("Impossible d‚Äôajouter la recette au planning.");
            }
          });
          addBtnContainer.appendChild(btn);
        }

        // suppression
        const deleteTopBtn = document.getElementById("deleteRecipe");
        if (deleteTopBtn) {
          deleteTopBtn.addEventListener("click", async () => {
            if (!recipeId) return;
            if (!confirm("Supprimer d√©finitivement cette recette ?")) return;
            try {
              const res = await fetch(
                `/api/delete-recipe?id=${encodeURIComponent(recipeId)}`,
                { method: "DELETE" },
              );
              if (!res.ok) throw new Error("HTTP " + res.status);
              window.location.replace("/recipes");
            } catch (err) {
              console.error("delete error:", err);
              alert("Impossible de supprimer la recette.");
            }
          });
        }
      });
    </script>
</Layout>
