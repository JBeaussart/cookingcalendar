---
// src/pages/recipes/[id].astro
import Layout from "../../layouts/Layout.astro";
import Modal from "../../components/Modal.astro";
import { db } from "../../firebase";
import { doc, getDoc } from "firebase/firestore";

const { id } = Astro.params;

const recipe = await (async () => {
  try {
    const ref = doc(db, "recipes", id);
    const snap = await getDoc(ref);
    if (!snap.exists()) return null;
    return { id: snap.id, ...snap.data() };
  } catch {
    return null;
  }
})();

const DEFAULT_IMG = "/images/default-recipe.jpg";
---

<Layout title={recipe?.title || "Recette"}>
  <Layout title={recipe?.title || "Recette"}>
    <div
      class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 pb-20"
    >
      <div class="mx-auto max-w-4xl px-4 py-8 sm:py-12">
        {
          recipe ? (
            <>
              {/* Navigation & Actions */}
              <div class="mb-6 flex items-center justify-between">
                <a
                  href="/recipes"
                  class="inline-flex items-center gap-2 rounded-xl bg-white px-4 py-2 text-sm font-medium text-slate-600 shadow-sm ring-1 ring-slate-200 transition hover:bg-slate-50 hover:text-blue-600"
                >
                  <svg
                    class="h-4 w-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10 19l-7-7m0 0l7-7m-7 7h18"
                    />
                  </svg>
                  Retour
                </a>

                <div class="flex items-center gap-2">
                  <button
                    id="openEdit"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white text-slate-600 shadow-sm ring-1 ring-slate-200 transition hover:bg-slate-50 hover:text-blue-600"
                    title="Modifier"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                      />
                    </svg>
                  </button>
                  <button
                    id="deleteRecipe"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white text-rose-600 shadow-sm ring-1 ring-slate-200 transition hover:bg-rose-50 hover:text-rose-700"
                    title="Supprimer"
                  >
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m1 0H8m8 0l-1-3H9L8 7"
                      />
                    </svg>
                  </button>
                </div>
              </div>

              {/* Main Card */}
              <div class="overflow-hidden rounded-3xl bg-white shadow-xl shadow-slate-200/50 ring-1 ring-slate-100">
                {/* Image Header */}
                <div class="relative h-64 sm:h-80 w-full">
                  <img
                    src={recipe.image || DEFAULT_IMG}
                    alt={recipe.title}
                    class="h-full w-full object-cover"
                    onerror={`this.src='${DEFAULT_IMG}'`}
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent" />

                  {/* Badges (Top Left) */}
                  <div class="absolute top-4 left-4 flex flex-wrap gap-2">
                    {recipe.maman && (
                      <span class="inline-flex items-center gap-1 rounded-full bg-pink-500/90 backdrop-blur-sm px-3 py-1 text-xs font-bold text-white shadow-sm">
                        <i class="fa-solid fa-paw" aria-hidden="true" /> Recette
                        de maman
                      </span>
                    )}
                    <span
                      class={`inline-flex items-center rounded-full px-3 py-1 text-xs font-bold text-white shadow-sm backdrop-blur-sm ${recipe.salt ? "bg-blue-500/90" : "bg-amber-500/90"}`}
                    >
                      {recipe.salt ? "Sal√©" : "Sucr√©"}
                    </span>
                  </div>

                  {/* Title Overlay (Bottom) */}
                  <div class="absolute bottom-0 left-0 right-0 p-6 sm:p-8">
                    <h1 class="text-3xl sm:text-4xl font-bold text-white drop-shadow-md">
                      {recipe.title}
                    </h1>
                  </div>

                  {/* Add Button Container (floating) */}
                  <div id="addBtnContainer" class="absolute right-4 top-4" />
                </div>

                {/* Content Grid */}
                <div class="grid gap-12 p-6 sm:p-10 md:grid-cols-[1fr_1.5fr]">
                  {/* Ingredients */}
                  <section>
                    <div class="rounded-2xl bg-slate-50 p-6 ring-1 ring-slate-100">
                      <h2 class="mb-6 flex items-center gap-3 text-lg font-bold text-slate-900">
                        <span class="flex h-8 w-8 items-center justify-center rounded-lg bg-white shadow-sm ring-1 ring-slate-200 text-slate-600">
                          üßÇ
                        </span>
                        Ingr√©dients
                      </h2>
                      <ul class="space-y-3">
                        {recipe.ingredients.map((i) => (
                          <li class="flex items-start gap-3 text-slate-700">
                            <div class="mt-1.5 h-1.5 w-1.5 flex-none rounded-full bg-slate-400" />
                            <span class="text-sm font-medium leading-relaxed">
                              {typeof i === "object" && i.quantity
                                ? `${i.item}: ${i.quantity} ${i.unit || ""}`
                                : typeof i === "object"
                                  ? i.item
                                  : i}
                            </span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  </section>

                  {/* Preparation */}
                  <section>
                    <h2 class="mb-6 flex items-center gap-3 text-lg font-bold text-slate-900">
                      <span class="flex h-8 w-8 items-center justify-center rounded-lg bg-white shadow-sm ring-1 ring-slate-200 text-slate-600">
                        üç≥
                      </span>
                      Pr√©paration
                    </h2>
                    <div class="space-y-8">
                      {recipe.steps.map((s, idx) => (
                        <div class="relative pl-8">
                          {/* Connecting Line (except for last item) */}
                          {idx !== recipe.steps.length - 1 && (
                            <div class="absolute left-[11px] top-8 bottom-[-32px] w-px bg-slate-200" />
                          )}

                          <span class="absolute left-0 top-0 flex h-6 w-6 items-center justify-center rounded-full bg-slate-100 text-xs font-bold text-slate-600 ring-4 ring-white">
                            {idx + 1}
                          </span>
                          <p class="text-slate-600 leading-relaxed text-base">
                            {s}
                          </p>
                        </div>
                      ))}
                    </div>
                  </section>
                </div>
              </div>

              <div
                id="recipe-data"
                data-id={recipe.id}
                data-title={recipe.title}
                data-image={recipe.image || ""}
                data-ingredients={encodeURIComponent(
                  JSON.stringify(recipe.ingredients || []),
                )}
                data-steps={encodeURIComponent(
                  JSON.stringify(recipe.steps || []),
                )}
                data-maman={String(!!recipe.maman)}
                data-salt={String(!!recipe.salt)}
                class="hidden"
              />

              {/* Modale d‚Äô√©dition */}
              <Modal id="editModal" title="Modifier la recette">
                <form id="editRecipeForm" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      Titre *
                    </label>
                    <input
                      id="eTitle"
                      type="text"
                      class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400"
                      required
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      Image (URL)
                    </label>
                    <input
                      id="eImage"
                      type="url"
                      placeholder="https://‚Ä¶"
                      class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400"
                    />
                  </div>

                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <label class="inline-flex items-center gap-2">
                      <input
                        id="eMaman"
                        type="checkbox"
                        class="h-5 w-5 rounded border-gray-300 text-emerald-600 focus:ring-2 focus:ring-emerald-400"
                      />
                      <span class="text-sm text-gray-800">
                        Recette de maman
                      </span>
                    </label>

                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">
                        Type *
                      </label>
                      <select
                        id="eSalt"
                        class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400"
                      >
                        <option value="salty">Sal√©</option>
                        <option value="sweet">Sucr√©</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <label class="block text-sm font-medium text-gray-700">
                        Ingr√©dients *
                      </label>
                      <button
                        type="button"
                        id="addIngRow"
                        class="text-emerald-600 hover:text-emerald-700 text-sm"
                      >
                        ‚ûï Ajouter un ingr√©dient
                      </button>
                    </div>
                    <div id="ingList" class="space-y-2" />
                  </div>

                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <label class="block text-sm font-medium text-gray-700">
                        √âtapes *
                      </label>
                      <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-500">
                          Glisser/D√©poser pour r√©ordonner
                        </span>
                        <button
                          type="button"
                          id="addStepRow"
                          class="text-emerald-600 hover:text-emerald-700 text-sm"
                        >
                          ‚ûï Ajouter une √©tape
                        </button>
                      </div>
                    </div>
                    <div id="stepsList" class="space-y-2" />
                  </div>

                  <div class="flex items-center justify-between gap-3 pt-2">
                    <button
                      type="button"
                      id="cancelEdit"
                      class="rounded-lg border border-gray-300 px-4 py-2 text-sm hover:bg-gray-50"
                    >
                      Annuler
                    </button>
                    <div class="flex items-center gap-3">
                      <button
                        type="button"
                        id="dangerDelete"
                        class="inline-flex items-center gap-2 rounded-lg bg-rose-600 px-4 py-2 text-sm font-medium text-white hover:bg-rose-700 transition"
                      >
                        Supprimer la recette
                      </button>
                      <button
                        type="submit"
                        class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-700 active:scale-[0.98] transition"
                      >
                        Enregistrer
                      </button>
                    </div>
                  </div>
                  <p id="editStatus" class="text-sm text-gray-500 mt-1" />
                </form>
              </Modal>
            </>
          ) : (
            <div class="flex min-h-[50vh] flex-col items-center justify-center text-center">
              <div class="mb-4 rounded-full bg-slate-100 p-4">
                <svg
                  class="h-8 w-8 text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
              <h2 class="text-xl font-semibold text-slate-900">
                Recette introuvable
              </h2>
              <p class="mt-2 text-slate-500">
                Cette recette n'existe pas ou a √©t√© supprim√©e.
              </p>
              <a
                href="/recipes"
                class="mt-6 inline-flex items-center gap-2 rounded-xl bg-blue-600 px-6 py-3 text-sm font-bold text-white shadow-lg shadow-blue-600/30 transition hover:bg-blue-700 hover:scale-105"
              >
                Retour aux recettes
              </a>
            </div>
          )
        }
      </div>
    </div>

    <script is:inline>
      document.addEventListener("DOMContentLoaded", () => {
        // + depuis le planning
        const params = new URLSearchParams(window.location.search);
        const dayParam = (params.get("day") || "").toLowerCase();
        const addBtnContainer = document.getElementById("addBtnContainer");
        const dataEl = document.getElementById("recipe-data");
        const recipeId = dataEl ? dataEl.getAttribute("data-id") : null;

        if (dayParam && recipeId) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/90 text-green-600 ring-1 ring-green-200 shadow hover:bg-white hover:text-green-700 hover:ring-green-300 transition";
          btn.title = `Ajouter au ${dayParam}`;
          btn.setAttribute(
            "aria-label",
            `Ajouter cette recette au ${dayParam}`,
          );
          btn.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16M20 12H4" /></svg>';
          btn.addEventListener("click", async () => {
            try {
              const res = await fetch("/api/assign-recipe", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ day: dayParam, id: recipeId }),
              });
              if (!res.ok) throw new Error("assign failed");
              window.location.href = "/";
            } catch (err) {
              console.error("Assignation √©chou√©e:", err);
              alert("Impossible d‚Äôajouter la recette au planning.");
            }
          });
          addBtnContainer.appendChild(btn);
        }

        // Modale √©dition + lock scroll
        const editModal = document.getElementById("editModal");
        const openEdit = document.getElementById("openEdit");
        const closeEdit = document.getElementById("editModal-close");
        const cancelEdit = document.getElementById("cancelEdit");
        const editStatus = document.getElementById("editStatus");

        let __lockScrollY = 0;
        function lockBodyScroll() {
          __lockScrollY = window.scrollY || 0;
          document.body.style.position = "fixed";
          document.body.style.top = `-${__lockScrollY}px`;
          document.body.style.left = "0";
          document.body.style.right = "0";
          document.body.style.width = "100%";
        }
        function unlockBodyScroll() {
          const y = Math.abs(parseInt(document.body.style.top || "0", 10)) || 0;
          document.body.style.position = "";
          document.body.style.top = "";
          document.body.style.left = "";
          document.body.style.right = "";
          document.body.style.width = "";
          window.scrollTo(0, y);
        }
        function openModal() {
          editModal.classList.remove("hidden");
          lockBodyScroll();
        }
        function closeModal() {
          editModal.classList.add("hidden");
          editStatus.textContent = "";
          unlockBodyScroll();
        }

        openEdit.addEventListener("click", () => {
          fillFormFromDataset();
          openModal();
        });
        closeEdit.addEventListener("click", closeModal);
        cancelEdit.addEventListener("click", (e) => {
          e.preventDefault();
          closeModal();
        });
        editModal.addEventListener("click", (e) => {
          if (e.target === editModal.firstElementChild) closeModal();
        });

        // Form + DnD
        const eTitle = document.getElementById("eTitle");
        const eImage = document.getElementById("eImage");
        const eMaman = document.getElementById("eMaman");
        const eSalt = document.getElementById("eSalt");
        const ingList = document.getElementById("ingList");
        const addIngRow = document.getElementById("addIngRow");
        const stepsList = document.getElementById("stepsList");
        const addStepRow = document.getElementById("addStepRow");

        function addIngredientRow(
          values = { item: "", quantity: "", unit: "" },
        ) {
          const row = document.createElement("div");
          row.className = "ingredient-row grid grid-cols-7 gap-2";
          row.innerHTML = `
          <input type="text" placeholder="Ingr√©dient" class="col-span-3 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400" value="${values.item || ""}" required>
          <input type="number" step="any" placeholder="Qt√©" class="col-span-2 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400" value="${values.quantity ?? ""}">
          <input type="text" placeholder="Unit√©" class="col-span-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400" value="${values.unit || ""}">
          <button type="button" class="col-span-1 rounded-md border border-gray-200 hover:bg-gray-100 text-gray-600 text-sm" title="Supprimer">‚úï</button>
        `;
          row
            .querySelector("button")
            .addEventListener("click", () => row.remove());
          ingList.appendChild(row);
        }
        addIngRow.addEventListener("click", () => addIngredientRow());

        let dragSrc = null;
        function addStepRowEl(value = "") {
          const row = document.createElement("div");
          row.className =
            "step-row grid grid-cols-[auto_1fr_auto] items-center gap-2 bg-gray-50 rounded-lg px-2 py-2";
          row.setAttribute("draggable", "true");
          row.innerHTML = `
          <span class="cursor-grab select-none px-1" title="Glisser pour r√©ordonner">‚ãÆ‚ãÆ</span>
          <input type="text" placeholder="D√©crire l‚Äô√©tape‚Ä¶" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400" value="${value}">
          <button type="button" class="rounded-md border border-gray-200 hover:bg-gray-100 text-gray-600 text-sm px-2" title="Supprimer">‚úï</button>
        `;
          row
            .querySelector("button")
            .addEventListener("click", () => row.remove());

          row.addEventListener("dragstart", (e) => {
            dragSrc = row;
            row.classList.add("opacity-60");
            e.dataTransfer.effectAllowed = "move";
            try {
              e.dataTransfer.setData("text/plain", "step");
            } catch {}
          });
          row.addEventListener("dragend", () => {
            dragSrc = null;
            row.classList.remove("opacity-60");
          });
          row.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
          });
          row.addEventListener("drop", (e) => {
            e.preventDefault();
            if (!dragSrc || dragSrc === row) return;
            const rect = row.getBoundingClientRect();
            const before = e.clientY < rect.top + rect.height / 2;
            if (before) stepsList.insertBefore(dragSrc, row);
            else stepsList.insertBefore(dragSrc, row.nextSibling);
          });

          stepsList.appendChild(row);
        }
        addStepRow.addEventListener("click", () => addStepRowEl());

        function fillFormFromDataset() {
          const d = document.getElementById("recipe-data");
          if (!d) return;
          eTitle.value = d.getAttribute("data-title") || "";
          eImage.value = d.getAttribute("data-image") || "";
          eMaman.checked = d.getAttribute("data-maman") === "true";
          eSalt.value =
            d.getAttribute("data-salt") === "true" ? "salty" : "sweet";

          ingList.innerHTML = "";
          let ing = [];
          try {
            ing =
              JSON.parse(
                decodeURIComponent(d.getAttribute("data-ingredients") || ""),
              ) || [];
          } catch {
            ing = [];
          }
          if (ing.length === 0) ing.push({ item: "", quantity: "", unit: "" });
          for (const row of ing)
            addIngredientRow({
              item: row.item || "",
              quantity: typeof row.quantity === "number" ? row.quantity : "",
              unit: row.unit || "",
            });

          stepsList.innerHTML = "";
          let st = [];
          try {
            st =
              JSON.parse(
                decodeURIComponent(d.getAttribute("data-steps") || ""),
              ) || [];
          } catch {
            st = [];
          }
          if (st.length === 0) st.push("");
          for (const s of st) addStepRowEl(s);
        }

        const editForm = document.getElementById("editRecipeForm");
        editForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const editStatus = document.getElementById("editStatus");
          editStatus.textContent = "Enregistrement‚Ä¶";

          const ingRows = Array.from(
            ingList.querySelectorAll(".ingredient-row"),
          );
          const ingredients = ingRows
            .map((row) => {
              const inputs = row.querySelectorAll("input");
              const item = inputs[0].value.trim();
              const qRaw = inputs[1].value.trim();
              const unit = inputs[2].value.trim();
              if (!item) return null;
              const obj = { item };
              if (qRaw !== "" && !isNaN(Number(qRaw)))
                obj.quantity = Number(qRaw);
              if (unit) obj.unit = unit;
              return obj;
            })
            .filter(Boolean);

          const stepInputs = Array.from(
            stepsList.querySelectorAll(".step-row input"),
          );
          const steps = stepInputs.map((el) => el.value.trim()).filter(Boolean);

          try {
            const res = await fetch("/api/update-recipe", {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id: recipeId,
                title: eTitle.value.trim(),
                image: eImage.value.trim(),
                maman: !!eMaman.checked,
                salt: eSalt.value === "salty",
                ingredients,
                steps,
              }),
            });
            if (!res.ok) throw new Error("HTTP " + res.status);
            editStatus.textContent = "‚úÖ Modifications enregistr√©es";
            setTimeout(() => window.location.reload(), 400);
          } catch (err) {
            console.error(err);
            editStatus.textContent = "‚ùå Erreur lors de l'enregistrement";
          }
        });

        // suppression
        const deleteTopBtn = document.getElementById("deleteRecipe");
        const deleteModalBtn = document.getElementById("dangerDelete");
        async function doDelete() {
          if (!recipeId) return;
          if (!confirm("Supprimer d√©finitivement cette recette ?")) return;
          try {
            const res = await fetch(
              `/api/delete-recipe?id=${encodeURIComponent(recipeId)}`,
              { method: "DELETE" },
            );
            if (!res.ok) throw new Error("HTTP " + res.status);
            window.location.replace("/recipes");
          } catch (err) {
            console.error("delete error:", err);
            alert("Impossible de supprimer la recette.");
          }
        }
        deleteTopBtn.addEventListener("click", doDelete);
        deleteModalBtn.addEventListener("click", doDelete);
      });
    </script>

    <style is:global>
      body.body-locked {
        padding-right: calc(100vw - 100%);
      }
    </style>
  </Layout>
</Layout>
