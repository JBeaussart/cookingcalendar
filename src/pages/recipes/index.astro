---
// src/pages/recipes/index.astro
import Layout from "../../layouts/Layout.astro";

import { getServerSession } from "../../lib/auth";
import { supabase } from "../../supabase";

// V√©rifier si l'utilisateur est connect√© et r√©cup√©rer le client Supabase en un seul appel
const { user, supabase: authSupabase } = await getServerSession(Astro.request);

// Si non connect√©, rediriger vers la page d'accueil
if (!user) {
  return Astro.redirect("/", 302);
}

// Type assertion pour user avec les propri√©t√©s n√©cessaires
type UserWithRole = {
  id: string;
  role?: string;
  user_role?: string;
};
const userWithRole = user as UserWithRole;
const userId = userWithRole.id;

// Type assertion pour le client Supabase
const authenticatedSupabase = (authSupabase || supabase) as typeof supabase;

// R√©cup√©rer les recettes de l'utilisateur
const { data: recipesData } = await authenticatedSupabase
  .from("recipes")
  .select("*")
  .eq("user_id", userId)
  .order("title", { ascending: true });

const recipes = recipesData || [];

const RECIPES_ENC = encodeURIComponent(JSON.stringify(recipes));
---

<Layout title="Recettes" user={user}>
  <div class="min-h-screen bg-gradient-to-br from-sage-50/30 via-sage-50/20 to-slate-50 w-full overflow-x-hidden">
    <div class="w-full max-w-6xl mx-auto px-4 pt-12 pb-32">
      <!-- Header -->
      <div class="mb-8 text-center">
        <div class="flex items-center justify-center gap-3 mb-2">
          <h1 class="text-4xl font-bold text-slate-900">Mes recettes</h1>
          {(userWithRole.role || userWithRole.user_role) !== "admin" && (userWithRole.role || userWithRole.user_role) !== "premium" && recipes.length === 20 && (
            <span id="limitBadge" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              20/20 recettes ‚Äì Limite atteinte
            </span>
          )}
        </div>
        <p class="text-slate-600">D√©couvrez et g√©rez votre collection</p>
      </div>

      <!-- Filters and Actions -->
      <div class="mb-8 flex flex-col gap-4 pb-12 sm:pb-8">
        <!-- Search Bar - Full Width -->
        <div class="relative">
          <input
            id="searchInput"
            type="text"
            placeholder="Rechercher une recette ou un ingr√©dient"
            class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 pl-11 text-sm focus:outline-none focus:ring-2 focus:ring-sage-300 focus:border-sage-300 shadow-sm transition-all"
          />
          <svg
            class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            />
          </svg>
        </div>

        <!-- Actions Row: Filters + Buttons -->
        <div class="flex flex-col lg:flex-row gap-4 lg:items-center lg:justify-between">
          <!-- Filters -->
          <div class="flex flex-wrap items-center gap-4 flex-1 lg:flex-initial">
            <!-- Segmented Control for Salt/Sweet -->
            <div
              class="flex items-center p-1 bg-slate-100 rounded-xl border border-slate-200"
              id="saltFilterContainer"
            >
              <button
                type="button"
                data-value="all"
                class="filter-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-bold rounded-lg transition-all shadow-sm bg-white text-sage-300"
              >
                Tous
              </button>
              <button
                type="button"
                data-value="salty"
                class="filter-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-sage-300 hover:bg-sage-50"
              >
                Sal√©
              </button>
              <button
                type="button"
                data-value="sweet"
                class="filter-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-sage-600 hover:bg-sage-50"
              >
                Sucr√©
              </button>
            </div>

            <!-- Bouton Maman s√©par√© √† droite (admin only) -->
            {(userWithRole.role || userWithRole.user_role) === "admin" && (
              <div class="flex items-center p-1 bg-slate-100 rounded-xl border border-slate-200 lg:ml-auto">
                <button
                  type="button"
                  id="mamanFilterBtn"
                  data-value="maman"
                  class="filter-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50 flex items-center justify-center"
                >
                  <svg class="w-4 h-4 text-pink-400" viewBox="0 0 512 512" fill="currentColor"><path d="M226.5 92.9c14.3 42.9-.3 86.2-32.6 96.8s-70.1-15.6-84.4-58.5.3-86.2 32.6-96.8 70.1 15.6 84.4 58.5zM100.4 198.6c18.9 32.4 14.3 70.1-10.2 84.1s-59.7-.9-78.5-33.3S-2.7 179.3 21.8 165.3s59.7.9 78.6 33.3zM69.2 401.2C121.6 259.9 214.7 224 256 224s134.4 35.9 186.8 177.2c3.6 9.7 5.2 20.1 5.2 30.5v1.6c0 25.8-20.9 46.7-46.7 46.7-11.5 0-22.9-1.4-34-4.2l-88-22c-15.3-3.8-31.3-3.8-46.6 0l-88 22c-11.1 2.8-22.5 4.2-34 4.2-25.8 0-46.7-20.9-46.7-46.7v-1.6c0-10.4 1.6-20.8 5.2-30.5zM324.5 92.9c14.3-42.9 51.7-73.1 84.4-58.5s46.9 53.9 32.6 96.8-51.7 73.1-84.4 58.5-46.9-53.9-32.6-96.8zM400.1 165.3c24.5 14 29.1 51.7 10.2 84.1s-54 48.2-78.5 33.3-29.1-51.7-10.2-84.1 54-48.2 78.5-33.3z"/></svg>
                  <span class="sm:inline ml-1">Ninette</span>
                </button>
              </div>
            )}
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-row gap-3 items-center flex-shrink-0">
            <div class="relative">
              <a
                href="/recipes/new"
                class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-sage-300 to-sage-500 px-4 sm:px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-sage-300/30 transition-all hover:from-sage-300 hover:to-sage-600 hover:shadow-xl hover:shadow-sage-300/40 hover:scale-105 active:scale-95 flex-1 sm:flex-initial"
              >
                <svg
                  class="h-5 w-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2.5"
                    d="M12 4v16m8-8H4"></path>
                </svg>
                Ajouter
              </a>
              {(userWithRole.role || userWithRole.user_role) !== "admin" && (userWithRole.role || userWithRole.user_role) !== "premium" && recipes.length < 20 && (
                <div class="absolute top-full left-0 mt-2 whitespace-nowrap text-left">
                  <span class="text-xs font-medium text-slate-500 block">
                    {recipes.length}/20 recettes
                  </span>
                </div>
              )}
            </div>
            {recipes.length > 0 && (
              <button
                id="exportPdfBtn"
                data-user-role={userWithRole.role || userWithRole.user_role || "free"}
                class={`inline-flex items-center justify-center gap-2 rounded-xl px-4 sm:px-6 py-3 text-sm font-semibold shadow-lg transition-all relative group flex-1 sm:flex-initial ${
                  (userWithRole.role || userWithRole.user_role) === "admin" || (userWithRole.role || userWithRole.user_role) === "premium"
                    ? "bg-slate-700 text-white shadow-slate-700/30 hover:bg-slate-800 hover:shadow-xl hover:scale-105 active:scale-95"
                    : "bg-slate-300 text-slate-500 opacity-50 cursor-not-allowed"
                }`}
              >
                {(userWithRole.role || userWithRole.user_role) === "admin" || (userWithRole.role || userWithRole.user_role) === "premium" ? (
                  <>
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                      />
                    </svg>
                    <span class="hidden sm:inline">T√©l√©charger en PDF</span>
                    <span class="sm:hidden">PDF</span>
                  </>
                ) : (
                  <>
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                      />
                    </svg>
                    <span class="hidden sm:inline">T√©l√©charger en PDF</span>
                    <span class="sm:hidden">PDF</span>
                    <!-- Tooltip pour utilisateurs FREE -->
                    <div
                      class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg whitespace-nowrap opacity-0 pointer-events-none group-hover:opacity-100 transition-opacity duration-300 z-50"
                      style="transition-delay: 300ms;"
                    >
                      üîí Export PDF accessible uniquement aux utilisateurs Premium
                      <div class="absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-slate-900"></div>
                    </div>
                  </>
                )}
              </button>
            )}
          </div>
        </div>
      </div>

      <!-- Toast Notification -->
      <div
        id="toast"
        class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl z-50 opacity-0 pointer-events-none transition-all duration-300 transform translate-y-4"
        role="alert"
        aria-live="polite"
      >
        <div class="flex items-center gap-3">
          <span id="toast-message"></span>
        </div>
      </div>

      <!-- Banni√®re limite atteinte (pour utilisateurs free avec 20 recettes) -->
      {(userWithRole.role || userWithRole.user_role) !== "admin" && (userWithRole.role || userWithRole.user_role) !== "premium" && (
        <div
          id="limitBanner"
          class={`mb-6 rounded-xl border border-blue-200 bg-blue-50 p-4 sm:p-5 shadow-sm transition-all duration-300 ${recipes.length === 20 ? '' : 'hidden'}`}
          style="background-color: #E0F7FA; border-color: #B2EBF2;"
        >
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-2xl">üéâ</span>
                <h3 class="text-base sm:text-lg font-semibold text-slate-800">
                  Bravo, vous avez atteint la limite de 20 recettes de votre plan gratuit !
                </h3>
              </div>
              <p class="text-sm sm:text-base text-slate-700 mb-4">
                Profitez de recettes illimit√©es avec le Premium et organisez tous vos repas facilement.
              </p>
              <a
                href="/premium"
                class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-semibold text-white transition-all duration-300 transform hover:scale-105 hover:shadow-lg"
                style="background-color: #00ACC1;"
              >
                D√©couvrir le Premium
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                </svg>
              </a>
            </div>
            <button
              id="closeLimitBanner"
              type="button"
              class="flex-shrink-0 p-1.5 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-blue-100 transition-colors"
              aria-label="Fermer la banni√®re"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      )}

      <!-- Grid -->
      <div
        id="grid"
        class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6"
      >
      </div>

      <!-- Data -->
      <div id="recipes-data" data-recipes={RECIPES_ENC} class="hidden"></div>
    </div>
  </div>

  <script is:inline>
    document.addEventListener("astro:page-load", () => {
      const DEFAULT_IMG = "/images/default-recipe.jpg";

      // Donn√©es
      const dataEl = document.getElementById("recipes-data");
      const enc = dataEl?.getAttribute("data-recipes") || "";
      /** @type {{id:string,title:string,image?:string,maman?:boolean,salt?:boolean,ingredients?: (string|{item:string,quantity?:number,unit?:string})[]}[]} */
      let ALL = [];
      try {
        ALL = JSON.parse(decodeURIComponent(enc)) || [];
      } catch (e) {
        console.error("Erreur de d√©codage des recettes:", e);
        ALL = [];
      }

      // UI
      const grid = document.getElementById("grid");
      const searchInput = document.getElementById("searchInput");
      
      // Fonction pour mettre √† jour le compteur sous le bouton "Ajouter" (pour < 20 recettes)
      function updateRecipeCounter() {
        const counter = document.getElementById("recipeCounter");
        const warningMessage = document.getElementById("recipeWarningMessage");
        
        if (!counter) return;
        
        // Afficher/masquer le compteur selon le nombre de recettes
        if (ALL.length < 20) {
          counter.textContent = `${ALL.length}/20 recettes`;
          counter.parentElement?.classList.remove("hidden");
          
          // Afficher ou masquer le message "Derni√®re recette disponible"
          if (warningMessage) {
            if (ALL.length === 19) {
              warningMessage.classList.remove("hidden");
            } else {
              warningMessage.classList.add("hidden");
            }
          }
        } else {
          // Masquer le compteur si on a 20 recettes ou plus
          counter.parentElement?.classList.add("hidden");
        }
      }
      
      // Fonction pour mettre √† jour la banni√®re et le badge (pour les utilisateurs free avec 20 recettes)
      function updateLimitBannerAndBadge() {
        const limitBanner = document.getElementById("limitBanner");
        const limitBadge = document.getElementById("limitBadge");
        
        // Si les √©l√©ments n'existent pas, l'utilisateur n'est pas free
        if (!limitBanner && !limitBadge) return;
        
        // Afficher/masquer le badge selon le nombre de recettes
        if (limitBadge) {
          if (ALL.length === 20) {
            limitBadge.classList.remove("hidden");
          } else {
            limitBadge.classList.add("hidden");
          }
        }
        
        // Afficher/masquer la banni√®re selon le nombre de recettes et si elle n'a pas √©t√© ferm√©e
        if (limitBanner) {
          const bannerDismissed = localStorage.getItem('limitBannerDismissed') === 'true';
          if (ALL.length === 20 && !bannerDismissed) {
            limitBanner.classList.remove("hidden");
          } else {
            limitBanner.classList.add("hidden");
          }
        }
      }
      
      // Fonction principale pour mettre √† jour tous les √©l√©ments
      function updateAllLimitElements() {
        updateRecipeCounter();
        updateLimitBannerAndBadge();
      }
      
      // G√©rer le bouton de fermeture de la banni√®re (une seule fois au chargement)
      const closeBannerBtn = document.getElementById("closeLimitBanner");
      if (closeBannerBtn) {
        closeBannerBtn.addEventListener('click', () => {
          const limitBanner = document.getElementById("limitBanner");
          if (limitBanner) {
            limitBanner.classList.add("hidden");
            localStorage.setItem('limitBannerDismissed', 'true');
          }
        });
      }
      
      // G√©rer le clic sur le badge pour faire d√©filer vers la banni√®re ou le haut de la page
      const limitBadge = document.getElementById("limitBadge");
      if (limitBadge) {
        limitBadge.style.cursor = 'pointer';
        limitBadge.addEventListener('click', () => {
          const limitBanner = document.getElementById("limitBanner");
          if (limitBanner && !limitBanner.classList.contains('hidden')) {
            // Si la banni√®re est visible, faire d√©filer vers elle
            limitBanner.scrollIntoView({ behavior: 'smooth', block: 'start' });
          } else {
            // Sinon, faire d√©filer vers le haut de la page
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });
      }
      
      // Mettre √† jour tous les √©l√©ments au chargement
      updateAllLimitElements();

      // Debounce pour la recherche (optimisation performance)
      let searchTimeout;
      function debounceSearch(fn, delay = 300) {
        return function(...args) {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      // Filter Logic
      let currentSaltMode = "all";
      let mamanFilterActive = false;
      const filterBtns = document.querySelectorAll(".filter-btn");
      const mamanFilterBtn = document.getElementById("mamanFilterBtn");

      filterBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const value = btn.dataset.value;
          
          // Si c'est le bouton "maman", toggle le filtre (peut √™tre combin√© avec les autres)
          if (value === "maman") {
            mamanFilterActive = !mamanFilterActive;
            // Mettre √† jour l'√©tat visuel du bouton maman
            if (mamanFilterActive) {
              btn.className = "filter-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-bold rounded-lg transition-all shadow-sm bg-white text-pink-600 flex items-center justify-center";
            } else {
              btn.className = "filter-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50 flex items-center justify-center";
            }
          } else {
            // Pour les autres filtres (all, salty, sweet)
            currentSaltMode = value;
            
            // Update visual state pour les filtres sal√©/sucr√©
            filterBtns.forEach((b) => {
              if (b.dataset.value === "maman") {
                // Ne pas modifier le bouton maman
                return;
              }
              if (b.dataset.value === currentSaltMode) {
                b.className = "filter-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-bold rounded-lg transition-all shadow-sm bg-white text-sage-300";
              } else {
                b.className = "filter-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50";
              }
            });
          }

          apply();
        });
      });

      const params = new URLSearchParams(window.location.search);
      const dayParam = (params.get("day") || "").toLowerCase();
      const slotParam = (params.get("slot") || "").toLowerCase();

      const normalize = (s) =>
        String(s || "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .trim();

      function recipeMatchesQuery(recipe, qNorm) {
        if (!qNorm) return true;
        // titre
        if (normalize(recipe.title).includes(qNorm)) return true;
        // ingr√©dients (string ou objet {item})
        const ing = Array.isArray(recipe.ingredients) ? recipe.ingredients : [];
        for (const it of ing) {
          const name =
            typeof it === "string" ? it : it && it.item ? it.item : "";
          if (normalize(name).includes(qNorm)) return true;
        }
        return false;
      }

      // Fonction pour g√©n√©rer une URL d'image optimis√©e via wsrv.nl (proxy gratuit)
      function getOptimizedImageUrl(originalUrl, width = 400, quality = 75) {
        // Ne pas optimiser les images locales/par d√©faut
        if (!originalUrl || originalUrl.startsWith('/') || originalUrl.startsWith('./')) {
          return originalUrl;
        }
        // Utiliser wsrv.nl pour redimensionner et compresser l'image
        // - w: largeur max
        // - h: hauteur max (calcul√©e proportionnellement)
        // - fit=cover: mode cover pour le crop
        // - q: qualit√© (1-100)
        // - output=webp: format WebP plus l√©ger
        const params = new URLSearchParams({
          url: originalUrl,
          w: width.toString(),
          h: Math.round(width * 0.75).toString(), // Ratio 4:3
          fit: 'cover',
          q: quality.toString(),
          output: 'webp'
        });
        return `https://wsrv.nl/?${params.toString()}`;
      }

      function makeBadge(text, cls) {
        const span = document.createElement("span");
        span.className = `inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${cls}`;
        span.textContent = text;
        return span;
      }

      function makeChefBadge() {
        const span = document.createElement("span");
        span.className =
          "inline-flex items-center gap-1 rounded-full px-2 py-0.5 bg-pink-100 text-pink-700";
        span.title = "Recette de maman";
        span.setAttribute("aria-label", "Recette de maman");
        span.innerHTML = `<svg class="w-3 h-3" viewBox="0 0 512 512" fill="currentColor"><path d="M226.5 92.9c14.3 42.9-.3 86.2-32.6 96.8s-70.1-15.6-84.4-58.5.3-86.2 32.6-96.8 70.1 15.6 84.4 58.5zM100.4 198.6c18.9 32.4 14.3 70.1-10.2 84.1s-59.7-.9-78.5-33.3S-2.7 179.3 21.8 165.3s59.7.9 78.6 33.3zM69.2 401.2C121.6 259.9 214.7 224 256 224s134.4 35.9 186.8 177.2c3.6 9.7 5.2 20.1 5.2 30.5v1.6c0 25.8-20.9 46.7-46.7 46.7-11.5 0-22.9-1.4-34-4.2l-88-22c-15.3-3.8-31.3-3.8-46.6 0l-88 22c-11.1 2.8-22.5 4.2-34 4.2-25.8 0-46.7-20.9-46.7-46.7v-1.6c0-10.4 1.6-20.8 5.2-30.5zM324.5 92.9c14.3-42.9 51.7-73.1 84.4-58.5s46.9 53.9 32.6 96.8-51.7 73.1-84.4 58.5-46.9-53.9-32.6-96.8zM400.1 165.3c24.5 14 29.1 51.7 10.2 84.1s-54 48.2-78.5 33.3-29.1-51.7-10.2-84.1 54-48.2 78.5-33.3z"/></svg>`;
        return span;
      }

      function makeCard(r) {
        const card = document.createElement("div");
        card.className =
          "group relative rounded-3xl bg-white shadow-lg shadow-slate-200/50 transition-all duration-300 hover:shadow-xl hover:shadow-slate-300/50 hover:scale-[1.02] overflow-hidden cursor-pointer";
        card.addEventListener("click", () => {
          const q = dayParam ? `?day=${encodeURIComponent(dayParam)}` : "";
          window.location.href = `/recipes/${r.id}${q}`;
        });

        if (dayParam || slotParam) {
          const addBtn = document.createElement("button");
          addBtn.type = "button";
          addBtn.className =
            "absolute right-2 top-2 z-10 flex h-10 w-10 items-center justify-center rounded-full bg-white/95 backdrop-blur-sm text-sage-300 shadow-lg transition-all hover:bg-sage-300 hover:text-white hover:scale-110";
          addBtn.title = dayParam
            ? `Ajouter au ${dayParam}`
            : `Choisir pour ${slotParam}`;
          addBtn.setAttribute(
            "aria-label",
            dayParam
              ? `Ajouter "${r.title}" au ${dayParam}`
              : `Choisir "${r.title}" pour ${slotParam}`,
          );
          addBtn.innerHTML =
            '<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16M20 12H4" /></svg>';
          addBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            e.preventDefault();
            try {
              const endpoint = dayParam
                ? "/api/assign-recipe"
                : "/api/assign-reception";
              const body = dayParam
                ? { day: dayParam, id: r.id }
                : { slot: slotParam, id: r.id };
              const res = await fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
              });
              if (!res.ok) throw new Error("assign failed");
              window.location.href = dayParam ? "/" : "/reception";
            } catch (err) {
              console.error("Assignation √©chou√©e:", err);
              alert("Impossible d'ajouter la recette.");
            }
          });
          card.appendChild(addBtn);
        }

        // Image container
        const imgWrap = document.createElement("div");
        imgWrap.className =
          "relative h-24 sm:h-32 overflow-hidden rounded-t-3xl bg-slate-100";
        const img = document.createElement("img");
        img.loading = "lazy";
        img.decoding = "async";
        img.className =
          "h-full w-full object-cover transition-transform duration-500 group-hover:scale-110";
        // Utiliser l'image optimis√©e pour les thumbnails (400px, qualit√© 75%)
        const originalImageUrl = r.image || DEFAULT_IMG;
        img.src = getOptimizedImageUrl(originalImageUrl, 400, 75);
        img.alt = r.title || "";
        img.onerror = () => {
          // En cas d'erreur, fallback vers l'image originale puis l'image par d√©faut
          if (img.src !== originalImageUrl && originalImageUrl !== DEFAULT_IMG) {
            img.src = originalImageUrl;
          } else {
            img.src = DEFAULT_IMG;
          }
        };
        imgWrap.appendChild(img);
        card.appendChild(imgWrap);

        // Content
        const body = document.createElement("div");
        body.className = "p-2 sm:p-3";

        const title = document.createElement("h3");
        title.className =
          "text-xs sm:text-sm font-bold text-slate-900 line-clamp-2 mb-1.5 sm:mb-2 min-h-[2rem] sm:min-h-[2.5rem]";
        title.textContent = r.title || "";
        body.appendChild(title);

        // Badges
        const meta = document.createElement("div");
        meta.className = "flex items-center gap-2 flex-wrap";
        if (typeof r.salt === "boolean")
          meta.appendChild(
            makeBadge(r.salt ? "Sal√©" : "Sucr√©", "bg-slate-100 text-slate-700"),
          );
        if (r.maman === true) meta.appendChild(makeChefBadge());
        body.appendChild(meta);

        card.appendChild(body);
        return card;
      }

      function render(list) {
        grid.innerHTML = "";
        if (!Array.isArray(list) || list.length === 0) {
          const empty = document.createElement("div");
          empty.className = "col-span-full text-center py-12";
          
          // Si aucune recette n'existe du tout
          if (ALL.length === 0) {
            empty.innerHTML = `
              <p class="text-lg text-slate-600 mb-6">La cuisine est encore vide, le chef n'est pas pass√© par l√† üòâ</p>
              <a
                href="/recipes/new"
                class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-sage-300 to-sage-500 px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-sage-300/30 transition-all hover:from-sage-300 hover:to-sage-600 hover:shadow-xl hover:scale-105 active:scale-95"
              >
                <svg
                  class="h-5 w-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2.5"
                    d="M12 4v16m8-8H4"></path>
                </svg>
                Cr√©er ma premi√®re recette
              </a>
            `;
          } else {
            // Si c'est une recherche qui ne trouve rien
            empty.innerHTML = `
              <p class="text-lg text-slate-600 mb-2">On a fouill√© partout‚Ä¶ m√™me sous la casserole.</p>
              <p class="text-slate-500">Aucune recette trouv√©e !</p>
            `;
          }
          
          grid.appendChild(empty);
          return;
        }
        list.forEach((r) => grid.appendChild(makeCard(r)));
      }

      function apply() {
        const q = normalize(searchInput.value);
        const mode = currentSaltMode;

        // üîé Titre OU ingr√©dients
        let list = ALL.filter((r) => recipeMatchesQuery(r, q));

        if (mamanFilterActive) list = list.filter((r) => r.maman === true);
        if (mode === "salty") list = list.filter((r) => r.salt === true);
        else if (mode === "sweet") list = list.filter((r) => r.salt === false);

        list.sort((a, b) => a.title.localeCompare(b.title, "fr"));
        render(list);
      }

      // Utiliser debounce pour la recherche (optimisation performance)
      searchInput.addEventListener("input", debounceSearch(() => apply(), 300));
      apply();

      // Fonction utilitaire pour afficher un toast
      function showToast(message, duration = 4000) {
        const toast = document.getElementById("toast");
        const toastMessage = document.getElementById("toast-message");
        if (!toast || !toastMessage) return;

        toastMessage.textContent = message;
        toast.classList.remove("opacity-0", "pointer-events-none", "translate-y-4");
        toast.classList.add("opacity-100", "pointer-events-auto", "translate-y-0");

        setTimeout(() => {
          toast.classList.remove("opacity-100", "pointer-events-auto", "translate-y-0");
          toast.classList.add("opacity-0", "pointer-events-none", "translate-y-4");
        }, duration);
      }

      // Gestion du bouton d'export PDF
      const exportPdfBtn = document.getElementById("exportPdfBtn");
      if (exportPdfBtn) {
        const userRole = exportPdfBtn.dataset.userRole || "free";
        const isPremiumOrAdmin = userRole === "admin" || userRole === "premium";

        if (isPremiumOrAdmin) {
          exportPdfBtn.addEventListener("click", async () => {
            try {
              // D√©tecter si on est sur mobile/iOS
              const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
              const isAndroid = /Android/.test(navigator.userAgent);
              const isMobile = isIOS || isAndroid;

              // Sur mobile, utiliser window.open() directement vers l'URL API
              // C'est la m√©thode la plus fiable pour iOS et Android
              if (isMobile) {
                // Afficher un message informatif pour iOS
                if (isIOS) {
                  showToast("üì± Le PDF s'ouvrira dans l'application Fichiers ou Books", 3000);
                }
                
                // V√©rifier d'abord que l'API fonctionne avec un fetch
                // Cela permet de d√©tecter les erreurs avant d'ouvrir la fen√™tre
                try {
                  const testResponse = await fetch("/api/export-recipes-pdf", {
                    method: "GET",
                    credentials: "include",
                  });
                  
                  if (!testResponse.ok) {
                    const errorData = await testResponse.json().catch(() => ({}));
                    if (testResponse.status === 403) {
                      showToast("üîí Export PDF r√©serv√© aux utilisateurs Premium", 4000);
                    } else if (testResponse.status === 401) {
                      showToast("üîê Veuillez vous reconnecter", 4000);
                    } else {
                      const errorMsg = errorData.error || "Erreur lors de la g√©n√©ration du PDF";
                      showToast(`‚ùå ${errorMsg}`, 4000);
                    }
                    return;
                  }
                  
                  // Si la r√©ponse est OK, ouvrir dans une nouvelle fen√™tre
                  const pdfUrl = "/api/export-recipes-pdf";
                  const newWindow = window.open(pdfUrl, "_blank", "noopener,noreferrer");
                  
                  if (!newWindow) {
                    // Popup bloqu√©e, essayer avec un lien temporaire
                    const a = document.createElement("a");
                    a.href = pdfUrl;
                    a.target = "_blank";
                    a.rel = "noopener noreferrer";
                    a.style.display = "none";
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                      document.body.removeChild(a);
                    }, 200);
                  }
                } catch (error) {
                  console.error("Erreur export PDF mobile:", error);
                  showToast("‚ùå Erreur lors de l'export PDF", 4000);
                }
                return;
              }

              // Sur desktop, utiliser la m√©thode avec fetch + blob
              exportPdfBtn.disabled = true;
              const originalContent = exportPdfBtn.innerHTML;
              exportPdfBtn.innerHTML = `
                <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="hidden sm:inline">G√©n√©ration...</span>
              `;

              const response = await fetch("/api/export-recipes-pdf", {
                method: "GET",
                credentials: "include",
              });

              if (!response.ok) {
                if (response.status === 403) {
                  showToast("üîí Export PDF r√©serv√© aux utilisateurs Premium", 4000);
                } else {
                  showToast("‚ùå Erreur lors de l'export PDF", 4000);
                }
                throw new Error("Export failed");
              }

              // T√©l√©charger le PDF sur desktop
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const filename = `mes-recettes-${new Date().toISOString().split("T")[0]}.pdf`;
              
              const a = document.createElement("a");
              a.href = url;
              a.download = filename;
              a.style.display = "none";
              document.body.appendChild(a);
              a.click();
              setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
              }, 200);

              showToast("‚úÖ PDF t√©l√©charg√© avec succ√®s", 2000);
            } catch (error) {
              console.error("Erreur export PDF:", error);
              showToast("‚ùå Erreur lors de l'export PDF", 4000);
            } finally {
              if (!isMobile) {
                exportPdfBtn.disabled = false;
                exportPdfBtn.innerHTML = originalContent || `
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                  </svg>
                  <span class="hidden sm:inline">T√©l√©charger en PDF</span>
                  <span class="sm:hidden">PDF</span>
                `;
              }
            }
          });
        } else {
          // Pour les utilisateurs FREE, afficher un toast au clic
          exportPdfBtn.addEventListener("click", (e) => {
            e.preventDefault();
            showToast("üîí Export PDF accessible uniquement aux utilisateurs Premium", 4000);
          });
        }
      }

    });
  </script>

  <style is:global>
    @media (max-width: 767px) {
      #grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</Layout>
