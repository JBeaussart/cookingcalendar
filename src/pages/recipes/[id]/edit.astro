---
// src/pages/recipes/[id]/edit.astro
import Layout from "../../../layouts/Layout.astro";
import { getServerSession } from "../../../lib/auth";
import { supabase } from "../../../supabase";

const { user, supabase: authSupabase } = await getServerSession(Astro.request);

if (!user) {
  return Astro.redirect("/", 302);
}

type UserWithRole = {
  id: string;
  role?: string;
  user_role?: string;
};
const userWithRole = user as UserWithRole;
const userId = userWithRole.id;
const userRole = userWithRole.role || userWithRole.user_role || "free";
const isAdminUser = userRole === "admin";

const authenticatedSupabase = (authSupabase || supabase) as typeof supabase;

const { id } = Astro.params;

const recipe = await (async () => {
  try {
    const { data, error } = await authenticatedSupabase
      .from("recipes")
      .select("*")
      .eq("id", id)
      .eq("user_id", userId)
      .single();
    if (error || !data) return null;
    return data;
  } catch {
    return null;
  }
})();

if (!recipe) {
  return Astro.redirect("/recipes", 302);
}

const RECIPE_ENC = encodeURIComponent(JSON.stringify({
  id: recipe.id,
  title: recipe.title,
  image: recipe.image || "",
  maman: !!recipe.maman,
  salt: !!recipe.salt,
  ingredients: recipe.ingredients || [],
  steps: recipe.steps || [],
}));
---

<Layout title={`Modifier ‚Äì ${recipe.title}`} user={user}>
  <div class="min-h-screen bg-gradient-to-br from-sage-50/30 via-sage-50/20 to-slate-50 pb-20">
    <div class="mx-auto max-w-2xl px-4 py-8 sm:py-12">
      <!-- Header -->
      <div class="mb-6 flex items-center justify-between">
        <a
          href={`/recipes/${id}`}
          class="inline-flex items-center gap-2 rounded-xl bg-white px-4 py-2 text-sm font-medium text-slate-600 shadow-sm ring-1 ring-slate-200 transition hover:bg-sage-50 hover:text-sage-300"
        >
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Retour
        </a>
      </div>

      <div>
          <h1 class="text-2xl font-bold text-slate-900 mb-6">Modifier la recette</h1>

          <form id="editRecipeForm" class="space-y-6">
            <!-- Status -->
            <div
              id="editStatus"
              class="hidden rounded-xl border-2 p-4 text-sm font-medium text-center"
              role="alert"
            ></div>

            <!-- General Info -->
            <div class="grid gap-6 sm:grid-cols-2">
              <div class="sm:col-span-2">
                <label class="block text-sm font-bold text-slate-700 mb-2">Titre de la recette</label>
                <input
                  id="eTitle"
                  type="text"
                  class="w-full rounded-xl border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:border-sage-300 focus:bg-white focus:ring-2 focus:ring-sage-200 transition-all"
                  required
                />
              </div>

              <div class="sm:col-span-2">
                <label class="block text-sm font-bold text-slate-700 mb-2">Image (URL)</label>
                <input
                  id="eImage"
                  type="url"
                  placeholder="https://exemple.com/image.jpg"
                  class="w-full rounded-xl border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:border-sage-300 focus:bg-white focus:ring-2 focus:ring-sage-200 transition-all"
                />
              </div>

              <div class="sm:col-span-2 flex flex-row items-end justify-between gap-4">
                <div>
                  <label class="block text-sm font-bold text-slate-700 mb-2">Type de plat</label>
                  <div class="flex items-center p-1 bg-slate-100 rounded-xl border border-slate-200 w-fit">
                    <button
                      type="button"
                      id="eSaltSalty"
                      data-value="salty"
                      class="salt-type-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-bold rounded-lg transition-all shadow-sm bg-white text-sage-300"
                    >
                      üßÇ Sal√©
                    </button>
                    <button
                      type="button"
                      id="eSaltSweet"
                      data-value="sweet"
                      class="salt-type-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50"
                    >
                      üç∞ Sucr√©
                    </button>
                  </div>
                </div>

                {isAdminUser && (
                  <div class="flex items-center pb-0">
                    <div class="flex items-center p-1 bg-slate-100 rounded-xl border border-slate-200">
                      <button
                        type="button"
                        id="eMamanBtn"
                        class="maman-form-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50 flex items-center justify-center"
                      >
                        <svg class="w-4 h-4 text-pink-400" viewBox="0 0 512 512" fill="currentColor"><path d="M226.5 92.9c14.3 42.9-.3 86.2-32.6 96.8s-70.1-15.6-84.4-58.5.3-86.2 32.6-96.8 70.1 15.6 84.4 58.5zM100.4 198.6c18.9 32.4 14.3 70.1-10.2 84.1s-59.7-.9-78.5-33.3S-2.7 179.3 21.8 165.3s59.7.9 78.6 33.3zM69.2 401.2C121.6 259.9 214.7 224 256 224s134.4 35.9 186.8 177.2c3.6 9.7 5.2 20.1 5.2 30.5v1.6c0 25.8-20.9 46.7-46.7 46.7-11.5 0-22.9-1.4-34-4.2l-88-22c-15.3-3.8-31.3-3.8-46.6 0l-88 22c-11.1 2.8-22.5 4.2-34 4.2-25.8 0-46.7-20.9-46.7-46.7v-1.6c0-10.4 1.6-20.8 5.2-30.5zM324.5 92.9c14.3-42.9 51.7-73.1 84.4-58.5s46.9 53.9 32.6 96.8-51.7 73.1-84.4 58.5-46.9-53.9-32.6-96.8zM400.1 165.3c24.5 14 29.1 51.7 10.2 84.1s-54 48.2-78.5 33.3-29.1-51.7-10.2-84.1 54-48.2 78.5-33.3z"/></svg>
                        <span class="sm:inline ml-1">Ninette</span>
                      </button>
                    </div>
                    <input id="eMaman" type="checkbox" class="sr-only" />
                  </div>
                )}
              </div>
            </div>

            <!-- Ingredients -->
            <div class="rounded-2xl bg-slate-50 p-5 ring-1 ring-slate-100">
              <div class="flex items-center justify-between mb-4">
                <label class="text-sm font-bold text-slate-900 flex items-center gap-2">
                  <span class="flex h-6 w-6 items-center justify-center rounded bg-white shadow-sm text-slate-500">üßÇ</span>
                  Ingr√©dients
                </label>
                <button
                  type="button"
                  id="addIngRow"
                  class="text-xs font-bold text-sage-300 hover:text-sage-300 hover:bg-sage-50 px-3 py-1.5 rounded-lg transition-colors"
                >
                  + Ajouter
                </button>
              </div>
              <div id="ingList" class="space-y-3"></div>
            </div>

            <!-- Steps -->
            <div class="rounded-2xl bg-slate-50 p-5 ring-1 ring-slate-100">
              <div class="flex items-center justify-between mb-4">
                <label class="text-sm font-bold text-slate-900 flex items-center gap-2">
                  <span class="flex h-6 w-6 items-center justify-center rounded bg-white shadow-sm text-slate-500">üç≥</span>
                  √âtapes de pr√©paration
                </label>
                <button
                  type="button"
                  id="addStepRow"
                  class="text-xs font-bold text-sage-300 hover:text-sage-300 hover:bg-sage-50 px-3 py-1.5 rounded-lg transition-colors"
                >
                  + Ajouter
                </button>
              </div>
              <div id="stepsList" class="space-y-3"></div>
              <p class="text-xs text-slate-400 mt-2 text-center">Utilisez les fl√®ches pour r√©ordonner les √©tapes</p>
            </div>

            <!-- Footer Actions -->
            <div class="flex items-center justify-between gap-3 pt-4 border-t border-slate-100">
              <button
                type="button"
                id="deleteRecipe"
                class="inline-flex items-center gap-2 rounded-xl bg-rose-50 px-4 py-2.5 text-sm font-bold text-rose-600 hover:bg-rose-100 hover:text-rose-700 transition-colors"
              >
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m1 0H8m8 0l-1-3H9L8 7" />
                </svg>
                Supprimer
              </button>

              <div class="flex items-center gap-3">
                <a
                  href={`/recipes/${id}`}
                  class="rounded-xl px-5 py-2.5 text-sm font-bold text-slate-600 hover:bg-slate-100 transition-colors"
                >
                  Annuler
                </a>
                <button
                  type="submit"
                  class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-sage-300 to-sage-500 px-6 py-2.5 text-sm font-bold text-white shadow-lg shadow-sage-300/20 hover:from-sage-300 hover:to-sage-600 hover:shadow-xl hover:scale-105 active:scale-95 transition-all"
                >
                  Enregistrer
                </button>
              </div>
            </div>
          </form>
      </div>

      <!-- Recipe data -->
      <div id="recipe-data" data-recipe={RECIPE_ENC} class="hidden"></div>
    </div>
  </div>

  <script is:inline>
    document.addEventListener("astro:page-load", () => {
      const editForm = document.getElementById("editRecipeForm");
      if (!editForm) return;

      const dataEl = document.getElementById("recipe-data");
      if (!dataEl) return;

      let recipe;
      try {
        recipe = JSON.parse(decodeURIComponent(dataEl.getAttribute("data-recipe") || ""));
      } catch {
        return;
      }

      const eTitle = document.getElementById("eTitle");
      const eImage = document.getElementById("eImage");
      const eMaman = document.getElementById("eMaman");
      const eMamanBtn = document.getElementById("eMamanBtn");
      const eSaltSalty = document.getElementById("eSaltSalty");
      const eSaltSweet = document.getElementById("eSaltSweet");
      const editStatus = document.getElementById("editStatus");
      const ingList = document.getElementById("ingList");
      const addIngRow = document.getElementById("addIngRow");
      const stepsList = document.getElementById("stepsList");
      const addStepRow = document.getElementById("addStepRow");
      let currentEditSaltType = recipe.salt ? "salty" : "sweet";

      // Salt type buttons
      const updateSaltButtons = (value) => {
        currentEditSaltType = value;
        if (value === "salty") {
          eSaltSalty.className = "salt-type-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-bold rounded-lg transition-all shadow-sm bg-white text-sage-300";
          eSaltSweet.className = "salt-type-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50";
        } else {
          eSaltSalty.className = "salt-type-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50";
          eSaltSweet.className = "salt-type-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-bold rounded-lg transition-all shadow-sm bg-white text-sage-300";
        }
      };
      if (eSaltSalty && eSaltSweet) {
        eSaltSalty.addEventListener("click", () => updateSaltButtons("salty"));
        eSaltSweet.addEventListener("click", () => updateSaltButtons("sweet"));
        updateSaltButtons(currentEditSaltType);
      }

      // Maman button
      if (eMaman && eMamanBtn) {
        eMaman.checked = recipe.maman;
        const updateButton = () => {
          if (eMaman.checked) {
            eMamanBtn.className = "maman-form-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-bold rounded-lg transition-all shadow-sm bg-white text-pink-600 flex items-center justify-center";
          } else {
            eMamanBtn.className = "maman-form-btn px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50 flex items-center justify-center";
          }
        };
        eMamanBtn.addEventListener("click", () => {
          eMaman.checked = !eMaman.checked;
          updateButton();
        });
        updateButton();
      }

      // Ingredient rows
      function addIngredientRow(values = { item: "", quantity: "", unit: "" }) {
        const row = document.createElement("div");
        row.className = "ingredient-row grid grid-cols-[1fr_auto_auto_auto] gap-2 items-start animate-fade-in";
        row.innerHTML = `
          <input type="text" placeholder="Ingr√©dient" class="w-full rounded-lg border-slate-200 bg-white px-3 py-2 text-sm focus:border-sage-300 focus:ring-2 focus:ring-sage-200 transition-all" value="${values.item || ""}" required>
          <input type="number" step="any" placeholder="Qt√©" class="w-20 rounded-lg border-slate-200 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" value="${values.quantity ?? ""}">
          <input type="text" placeholder="Unit√©" class="w-20 rounded-lg border-slate-200 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" value="${values.unit || ""}">
          <button type="button" class="p-2 text-slate-400 hover:text-rose-500 transition-colors" title="Supprimer">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m1 0H8m8 0l-1-3H9L8 7" /></svg>
          </button>
        `;
        row.querySelector("button").addEventListener("click", () => row.remove());
        ingList.appendChild(row);
      }
      addIngRow.addEventListener("click", () => addIngredientRow());

      // Step rows
      let dragSrc = null;
      function addStepRowEl(value = "") {
        const row = document.createElement("div");
        row.className = "step-row group flex items-start gap-3 bg-white rounded-xl border border-slate-200 p-3 shadow-sm hover:border-sage-300 transition-all animate-fade-in";
        row.setAttribute("draggable", "true");
        row.innerHTML = `
          <div class="flex flex-col items-center gap-1 mt-1">
            <button type="button" class="move-up p-1 text-slate-400 hover:text-slate-600 transition-colors" title="Monter">
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
            </button>
            <div class="hidden sm:block cursor-grab active:cursor-grabbing text-slate-400 hover:text-slate-600" title="Glisser pour r√©ordonner">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" /></svg>
            </div>
            <button type="button" class="move-down p-1 text-slate-400 hover:text-slate-600 transition-colors" title="Descendre">
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </button>
          </div>
          <textarea
            placeholder="D√©crivez l'√©tape de pr√©paration..."
            class="flex-1 rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:bg-white focus:border-sage-300 focus:ring-2 focus:ring-sage-200 transition-all resize-y min-h-[80px]"
          >${value}</textarea>
          <button type="button" class="step-delete mt-2 text-slate-400 hover:text-rose-500 transition-colors sm:opacity-0 sm:group-hover:opacity-100" title="Supprimer">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        `;
        row.querySelector(".step-delete").addEventListener("click", () => row.remove());
        row.querySelector(".move-up").addEventListener("click", () => {
          const prev = row.previousElementSibling;
          if (prev) stepsList.insertBefore(row, prev);
        });
        row.querySelector(".move-down").addEventListener("click", () => {
          const next = row.nextElementSibling;
          if (next) stepsList.insertBefore(next, row);
        });

        row.addEventListener("dragstart", (e) => {
          dragSrc = row;
          row.classList.add("opacity-50", "scale-[0.98]");
          e.dataTransfer.effectAllowed = "move";
          try { e.dataTransfer.setData("text/plain", "step"); } catch {}
        });
        row.addEventListener("dragend", () => {
          dragSrc = null;
          row.classList.remove("opacity-50", "scale-[0.98]");
        });
        row.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });
        row.addEventListener("drop", (e) => {
          e.preventDefault();
          if (!dragSrc || dragSrc === row) return;
          const rect = row.getBoundingClientRect();
          const before = e.clientY < rect.top + rect.height / 2;
          if (before) stepsList.insertBefore(dragSrc, row);
          else stepsList.insertBefore(dragSrc, row.nextSibling);
        });

        stepsList.appendChild(row);
      }
      addStepRow.addEventListener("click", () => addStepRowEl());

      // Fill form with recipe data
      eTitle.value = recipe.title || "";
      eImage.value = recipe.image || "";

      const ing = Array.isArray(recipe.ingredients) ? recipe.ingredients : [];
      if (ing.length === 0) ing.push({ item: "", quantity: "", unit: "" });
      for (const row of ing) {
        addIngredientRow({
          item: row.item || "",
          quantity: typeof row.quantity === "number" ? row.quantity : "",
          unit: row.unit || "",
        });
      }

      const st = Array.isArray(recipe.steps) ? recipe.steps : [];
      if (st.length === 0) st.push("");
      for (const s of st) addStepRowEl(s);

      // Form submit
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        editStatus.textContent = "Enregistrement‚Ä¶";
        editStatus.className = "rounded-xl border-2 border-blue-200 bg-blue-50 p-4 text-sm font-medium text-blue-700 text-center";
        editStatus.classList.remove("hidden");

        const ingRows = Array.from(ingList.querySelectorAll(".ingredient-row"));
        const ingredients = ingRows
          .map((row) => {
            const inputs = row.querySelectorAll("input");
            const item = inputs[0].value.trim();
            const qRaw = inputs[1].value.trim();
            const unit = inputs[2].value.trim();
            if (!item) return null;
            const obj = { item };
            if (qRaw !== "" && !isNaN(Number(qRaw))) obj.quantity = Number(qRaw);
            if (unit) obj.unit = unit;
            return obj;
          })
          .filter(Boolean);

        const stepInputs = Array.from(stepsList.querySelectorAll(".step-row textarea"));
        const steps = stepInputs.map((el) => el.value.trim()).filter(Boolean);

        try {
          const res = await fetch("/api/update-recipe", {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id: recipe.id,
              title: eTitle.value.trim(),
              image: eImage.value.trim(),
              maman: eMaman ? !!eMaman.checked : false,
              salt: currentEditSaltType === "salty",
              ingredients,
              steps,
            }),
          });
          if (!res.ok) throw new Error("HTTP " + res.status);
          editStatus.textContent = "Modifications enregistr√©es !";
          editStatus.className = "rounded-xl border-2 border-green-200 bg-green-50 p-4 text-sm font-medium text-green-700 text-center";
          setTimeout(() => {
            window.location.href = `/recipes/${recipe.id}`;
          }, 800);
        } catch (err) {
          console.error(err);
          editStatus.textContent = "Erreur lors de l'enregistrement";
          editStatus.className = "rounded-xl border-2 border-red-300 bg-red-50 p-4 text-sm font-medium text-red-700 text-center";
          editStatus.classList.remove("hidden");
        }
      });

      // Delete
      const deleteBtn = document.getElementById("deleteRecipe");
      deleteBtn.addEventListener("click", async () => {
        if (!confirm("Supprimer d√©finitivement cette recette ?")) return;
        try {
          const res = await fetch(`/api/delete-recipe?id=${encodeURIComponent(recipe.id)}`, { method: "DELETE" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          window.location.replace("/recipes");
        } catch (err) {
          console.error("delete error:", err);
          alert("Impossible de supprimer la recette.");
        }
      });
    });
  </script>
</Layout>
