---
import Layout from "../layouts/Layout.astro";
import { getServerSession, getAuthenticatedSupabase } from "../lib/auth";
import { supabase } from "../supabase";

// Vérifier si l'utilisateur est connecté
const { user } = await getServerSession(Astro.request);

// Si non connecté, rediriger vers la page d'accueil
if (!user) {
  return Astro.redirect("/", 302);
}

// Récupérer un client Supabase authentifié
const { supabase: authSupabase } = await getAuthenticatedSupabase(Astro.request);
const authenticatedSupabase = authSupabase || supabase;

type SlotKey = "aperitif" | "entree" | "plat" | "dessert";

const SLOT_LABELS: Record<SlotKey, string> = {
  aperitif: "Apéritif",
  entree: "Entrée",
  plat: "Plat",
  dessert: "Dessert",
};

const { data: receptionData } = await authenticatedSupabase
  .from("reception")
  .select("data")
  .eq("user_id", user.id)
  .limit(1)
  .single();

const data = receptionData?.data || {};

async function loadRecipe(id?: string | null) {
  if (!id) return null;
  try {
    const { data: recipe, error } = await authenticatedSupabase
      .from("recipes")
      .select("*")
      .eq("id", id)
      .eq("user_id", user.id) // S'assurer que l'utilisateur ne peut voir que ses propres recettes
      .single();

    return error || !recipe ? null : recipe;
  } catch {
    return null;
  }
}

const current = {
  aperitif: await loadRecipe(data.aperitifId ?? null),
  entree: await loadRecipe(data.entreeId ?? null),
  plat: await loadRecipe(data.platId ?? null),
  dessert: await loadRecipe(data.dessertId ?? null),
};
---

<Layout title="Reception">
  <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
    <div class="mx-auto max-w-3xl px-4 py-12">
      <!-- Header -->
      <div class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-slate-900 mb-2">
          Menu de réception
        </h1>
        <p class="text-slate-600">Composez votre menu parfait</p>
      </div>

      <!-- Slots Grid -->
      <div class="grid grid-cols-1 gap-6 pb-16 sm:pb-0">
        {
          (Object.keys(SLOT_LABELS) as SlotKey[]).map((slot) => {
            const label = SLOT_LABELS[slot];
            const r = current[slot];
            const img = r?.image?.trim?.()
              ? r.image
              : "/images/default-recipe.jpg";
            return (
              <section class="group relative rounded-3xl bg-white shadow-lg shadow-slate-200/50 transition-all duration-300 hover:shadow-xl hover:shadow-slate-300/50 overflow-hidden">
                {r ? (
                  <>
                    {/* Recipe Image Background */}
                    <div class="relative h-28 overflow-hidden rounded-t-3xl">
                      <img
                        src={img}
                        alt={r.title}
                        class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110"
                      />
                      <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent" />

                      {/* Slot Badge */}
                      <div class="absolute top-2 left-2">
                        <div class="rounded-full bg-white/95 backdrop-blur-sm px-3 py-1 shadow-lg">
                          <span class="text-xs font-bold text-slate-900">
                            {label}
                          </span>
                        </div>
                      </div>

                      {/* Recipe Title Overlay */}
                      <div class="absolute bottom-0 left-0 right-0 p-3">
                        <a
                          href={`/recipes/${r.id}`}
                          class="block text-base font-bold text-white drop-shadow-lg hover:text-blue-200 transition line-clamp-2"
                        >
                          {r.title}
                        </a>
                      </div>
                    </div>

                    {/* Actions Bar */}
                    <div class="flex items-center justify-between border-t border-slate-100 bg-slate-50/50 px-3 py-2">
                      <a
                        href={`/recipes/${r.id}`}
                        class="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-blue-600 transition"
                      >
                        <svg
                          class="h-4 w-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                          />
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                          />
                        </svg>
                        Voir
                      </a>

                      <div class="flex items-center gap-1">
                        <a
                          href={`/recipes?slot=${slot}`}
                          title="Changer la recette"
                          class="flex h-8 w-8 items-center justify-center rounded-lg text-slate-600 hover:bg-slate-200/50 transition"
                        >
                          <svg
                            class="h-4 w-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5"
                            />
                          </svg>
                        </a>

                        <button
                          type="button"
                          title="Retirer"
                          class="flex h-8 w-8 items-center justify-center rounded-lg text-slate-600 hover:bg-red-50 hover:text-red-600 transition"
                          data-clear={slot}
                        >
                          <svg
                            class="h-4 w-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M6 18L18 6M6 6l12 12"
                            />
                          </svg>
                        </button>
                      </div>
                    </div>
                  </>
                ) : (
                  <>
                    {/* Empty state */}
                    <a href={`/recipes?slot=${slot}`} class="block">
                      <div class="relative h-28 overflow-hidden rounded-3xl bg-gradient-to-br from-slate-100 to-slate-200 transition hover:from-slate-200 hover:to-slate-300">
                        {/* Slot Badge */}
                        <div class="absolute top-2 left-2">
                          <div class="rounded-full bg-white/95 backdrop-blur-sm px-3 py-1 shadow-lg">
                            <span class="text-xs font-bold text-slate-900">
                              {label}
                            </span>
                          </div>
                        </div>

                        {/* Centered Add Icon */}
                        <div class="absolute inset-0 flex items-center justify-center">
                          <div class="flex h-12 w-12 items-center justify-center rounded-full bg-blue-600 text-white shadow-lg shadow-blue-600/30 transition-all hover:bg-blue-700 hover:scale-110">
                            <svg
                              class="h-6 w-6"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2.5"
                                d="M12 4v16m8-8H4"
                              />
                            </svg>
                          </div>
                        </div>
                      </div>
                    </a>
                  </>
                )}
              </section>
            );
          })
        }
      </div>

      <p id="status" class="mt-4 text-center text-sm text-slate-500"></p>
    </div>
  </div>

  <script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
      const status = (t) => {
        const el = document.getElementById("status");
        if (el) el.textContent = t || "";
      };
      document.querySelectorAll("button[data-clear]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const slot = btn.getAttribute("data-clear");
          if (!slot) return;
          status("Suppression…");
          try {
            const r = await fetch("/api/assign-reception", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ slot, id: null }),
            });
            if (!r.ok) throw new Error("HTTP " + r.status);
            status("✅ Mis à jour");
            window.location.reload();
          } catch (e) {
            console.error(e);
            status("❌ Erreur");
          }
        });
      });
    });
  </script>
</Layout>
