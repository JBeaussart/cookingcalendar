---
import Layout from "../layouts/Layout.astro";
import { getServerSession } from "../lib/auth";
import { supabase } from "../supabase";

// Vérifier si l'utilisateur est connecté et récupérer le client Supabase en un seul appel
const { user, profile, supabase: authSupabase } = await getServerSession(Astro.request);
if (!user) return Astro.redirect("/login", 302);

type UserWithRole = {
  id: string;
  email?: string;
  role?: string;
  user_role?: string;
  created_at?: string;
};

const userWithRole = user as UserWithRole;
const userId = userWithRole.id;

const db = (authSupabase || supabase) as typeof supabase;

// Requêtes indépendantes en parallèle
const [{ count: recipesCount }, { count: planningCount }] = await Promise.all([
  db.from("recipes").select("*", { count: "exact", head: true }).eq("user_id", userId),
  db.from("planning").select("*", { count: "exact", head: true }).eq("user_id", userId).not("recipe_id", "is", null),
]);

const formatDate = (date?: string) =>
  date
    ? new Date(date).toLocaleDateString("fr-FR", {
        year: "numeric",
        month: "long",
        day: "numeric",
      })
    : "—";

const role =
  userWithRole.role || userWithRole.user_role || "free";

const roleLabel =
  role === "admin" ? "Administrateur" :
  role === "premium" ? "Premium" :
  "Gratuit";

const roleStyle =
  role === "admin"
    ? "bg-purple-100 text-purple-700"
    : role === "premium"
    ? "bg-sage-100 text-sage-700"
    : "bg-gray-100 text-gray-700";
---

<Layout title="Mon compte" user={user}>
  <div class="min-h-screen bg-sage-50 pb-24">
    <div class="max-w-3xl mx-auto px-4 py-10 space-y-10">

      <!-- HEADER -->
      <header>
        <h1 class="text-3xl font-bold text-gray-900 mb-1">
          Mon compte
        </h1>
        <p class="text-gray-600">
          Vos informations et paramètres essentiels
        </p>
      </header>

      <!-- COMPTE -->
      <section class="bg-white rounded-2xl border border-gray-200 p-6 space-y-4">
        <div>
          <p class="text-sm text-gray-500">Email</p>
          <p class="font-medium">{userWithRole.email || profile?.email}</p>
        </div>

        <div class="flex items-center gap-3">
          <span class={`px-3 py-1 rounded-full text-sm font-medium ${roleStyle}`}>
            {roleLabel}
          </span>
          <span class="text-sm text-gray-500">
            Membre depuis {formatDate(profile?.created_at || userWithRole.created_at)}
          </span>
        </div>
      </section>

      <!-- STATS -->
      <section class="grid grid-cols-2 gap-4">
        <div class="bg-white rounded-xl border border-gray-200 p-4 text-center">
          <p class="text-2xl font-bold">{recipesCount || 0}</p>
          <p class="text-sm text-gray-600">Recettes créées</p>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4 text-center">
          <p class="text-2xl font-bold">{planningCount || 0}</p>
          <p class="text-sm text-gray-600">Recettes planifiées</p>
        </div>
      </section>

      <!-- MOT DE PASSE -->
      <section class="bg-white rounded-2xl border border-gray-200 p-6">
        <h2 class="text-lg font-semibold mb-4">
          Changer de mot de passe
        </h2>

        <form id="change-password-form" class="space-y-4">
          <input type="password" name="currentPassword" placeholder="Mot de passe actuel"
            class="w-full px-4 py-3 border rounded-lg" required />
          <input type="password" name="newPassword" placeholder="Nouveau mot de passe"
            class="w-full px-4 py-3 border rounded-lg" required minlength="6" />
          <input type="password" name="confirmPassword" placeholder="Confirmer le mot de passe"
            class="w-full px-4 py-3 border rounded-lg" required minlength="6" />

          <div id="password-error" class="hidden text-sm text-red-600"></div>
          <div id="password-success" class="hidden text-sm text-green-600"></div>

          <button
            type="submit"
            class="w-full py-3 bg-sage-600 text-white rounded-lg font-medium"
          >
            Modifier le mot de passe
          </button>
        </form>
      </section>

      <!-- ACTIONS -->
      <section class="space-y-3">
        <a href="/recipes" class="block w-full py-3 bg-sage-100 text-sage-700 rounded-lg text-center">
          Voir mes recettes
        </a>
        <a href="/planning" class="block w-full py-3 border rounded-lg text-center">
          Voir mon planning
        </a>
        <form method="post" action="/api/auth/logout">
          <button class="w-full py-3 border border-red-200 text-red-600 rounded-lg">
            Déconnexion
          </button>
        </form>
      </section>

      <!-- DANGER -->
      <section class="border border-red-200 bg-red-50 rounded-2xl p-6">
        <button
          id="delete-account-button"
          class="w-full py-3 bg-red-600 text-white rounded-lg font-medium"
        >
          Supprimer mon compte
        </button>
        <div id="delete-error" class="hidden text-sm text-red-600 mt-3"></div>
        <p class="text-sm text-red-700 mt-3">
          Cette action est définitive et irréversible.
        </p>
      </section>

    </div>
  </div>
</Layout>

<!-- JS inchangé : change-password + delete-account -->


<script>
  const changePasswordForm = document.getElementById("change-password-form") as HTMLFormElement | null;
  const errorDiv = document.getElementById("password-error");
  const successDiv = document.getElementById("password-success");

  if (changePasswordForm && errorDiv && successDiv) {
    changePasswordForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Masquer les messages précédents
      errorDiv.classList.add("hidden");
      successDiv.classList.add("hidden");

      const formData = new FormData(changePasswordForm);
      const currentPassword = formData.get("currentPassword");
      const newPassword = formData.get("newPassword") as string | null;
      const confirmPassword = formData.get("confirmPassword");

      // Validation côté client
      if (newPassword !== confirmPassword) {
        errorDiv.textContent = "Les nouveaux mots de passe ne correspondent pas";
        errorDiv.classList.remove("hidden");
        return;
      }

      if (!newPassword || newPassword.length < 6) {
        errorDiv.textContent = "Le nouveau mot de passe doit contenir au moins 6 caractères";
        errorDiv.classList.remove("hidden");
        return;
      }

      // Désactiver le bouton pendant la requête
      const submitButton = changePasswordForm.querySelector('button[type="submit"]') as HTMLButtonElement | null;
      if (!submitButton) return;
      
      const originalButtonText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = '<svg class="inline-block w-4 h-4 mr-2 animate-spin" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Modification...';

      try {
        const response = await fetch("/api/auth/change-password", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            currentPassword,
            newPassword,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          errorDiv.textContent = data.error || "Une erreur est survenue";
          errorDiv.classList.remove("hidden");
        } else {
          successDiv.textContent = data.message || "Mot de passe modifié avec succès";
          successDiv.classList.remove("hidden");
          changePasswordForm.reset();
          
          // Masquer le message de succès après 5 secondes
          setTimeout(() => {
            successDiv.classList.add("hidden");
          }, 5000);
        }
      } catch (error) {
        errorDiv.textContent = "Une erreur est survenue. Veuillez réessayer.";
        errorDiv.classList.remove("hidden");
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.innerHTML = originalButtonText;
        }
      }
    });
  }

  // Gestion de la suppression de compte
  const deleteAccountButton = document.getElementById("delete-account-button") as HTMLButtonElement | null;
  const deleteErrorDiv = document.getElementById("delete-error");

  if (deleteAccountButton && deleteErrorDiv) {
    deleteAccountButton.addEventListener("click", async () => {
      // Afficher une alerte de confirmation
      const confirmed = confirm(
        "⚠️ ATTENTION : Cette action est irréversible !\n\n" +
        "La suppression de votre compte entraînera :\n" +
        "• La suppression de toutes vos recettes\n" +
        "• La suppression de votre planning\n" +
        "• La suppression de toutes vos données\n\n" +
        "Êtes-vous sûr de vouloir supprimer votre compte ?\n\n" +
        "Tapez 'SUPPRIMER' dans la prochaine boîte de dialogue pour confirmer."
      );

      if (!confirmed) {
        return;
      }

      // Demander une confirmation supplémentaire avec un mot-clé
      const confirmation = prompt(
        "Pour confirmer la suppression, veuillez taper 'SUPPRIMER' (en majuscules) :"
      );

      if (confirmation !== "SUPPRIMER") {
        deleteErrorDiv.textContent = "Suppression annulée. Le mot de confirmation ne correspond pas.";
        deleteErrorDiv.classList.remove("hidden");
        setTimeout(() => {
          deleteErrorDiv.classList.add("hidden");
        }, 5000);
        return;
      }

      // Masquer les messages précédents
      deleteErrorDiv.classList.add("hidden");

      // Désactiver le bouton pendant la requête
      deleteAccountButton.disabled = true;
      const originalText = deleteAccountButton.innerHTML;
      deleteAccountButton.innerHTML = '<svg class="inline-block w-4 h-4 mr-2 animate-spin" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Suppression en cours...';

      try {
        const response = await fetch("/api/delete-account", {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        });

        let data;
        try {
          data = await response.json();
        } catch (jsonError) {
          // Si la réponse n'est pas du JSON, c'est probablement une erreur serveur
          const text = await response.text();
          console.error("Erreur lors du parsing de la réponse:", text);
          deleteErrorDiv.textContent = `Erreur serveur (${response.status}): ${text || "Réponse invalide"}`;
          deleteErrorDiv.classList.remove("hidden");
          deleteAccountButton.disabled = false;
          deleteAccountButton.innerHTML = originalText;
          return;
        }

        if (!response.ok) {
          const errorMessage = data.error || data.details || "Une erreur est survenue lors de la suppression";
          deleteErrorDiv.textContent = errorMessage + (data.code ? ` (Code: ${data.code})` : "");
          deleteErrorDiv.classList.remove("hidden");
          deleteAccountButton.disabled = false;
          deleteAccountButton.innerHTML = originalText;
        } else {
          // Déconnecter l'utilisateur et rediriger vers la landing page
          // On fait d'abord une déconnexion pour nettoyer la session côté client
          try {
            await fetch("/api/auth/logout", {
              method: "POST",
            });
          } catch (logoutError) {
            // Ignorer les erreurs de déconnexion, on redirige quand même
            console.warn("Erreur lors de la déconnexion:", logoutError);
          }
          
          // Rediriger vers la landing page
          alert("Votre compte a été supprimé avec succès.");
          // Utiliser replace pour éviter que l'utilisateur puisse revenir en arrière
          window.location.replace("/");
        }
      } catch (error) {
        console.error("Erreur lors de la suppression:", error);
        deleteErrorDiv.textContent = `Une erreur est survenue: ${error instanceof Error ? error.message : "Erreur inconnue"}`;
        deleteErrorDiv.classList.remove("hidden");
        deleteAccountButton.disabled = false;
        deleteAccountButton.innerHTML = originalText;
      }
    });
  }
</script>

