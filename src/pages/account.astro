---
// src/pages/account.astro
import Layout from "../layouts/Layout.astro";
import { getServerSession, getAuthenticatedSupabase } from "../lib/auth";
import { supabase } from "../supabase";

// Vérifier si l'utilisateur est connecté
const { user } = await getServerSession(Astro.request);

// Si non connecté, rediriger vers la page de connexion
if (!user) {
  return Astro.redirect("/login", 302);
}

// Type assertion pour user
type UserWithRole = {
  id: string;
  email?: string;
  role?: string;
  user_role?: string;
  created_at?: string;
};
const userWithRole = user as UserWithRole;
const userId = userWithRole.id;

// Récupérer un client Supabase authentifié
const { supabase: authSupabase } = await getAuthenticatedSupabase(Astro.request);
const authenticatedSupabase = (authSupabase || supabase) as typeof supabase;

// Récupérer le profil complet de l'utilisateur
const { data: profile } = await authenticatedSupabase
  .from("user_profiles")
  .select("*")
  .eq("id", userId)
  .single();

// Compter les recettes de l'utilisateur
const { count: recipesCount } = await authenticatedSupabase
  .from("recipes")
  .select("*", { count: "exact", head: true })
  .eq("user_id", userId);

// Compter les recettes dans le planning
const { count: planningCount } = await authenticatedSupabase
  .from("planning")
  .select("*", { count: "exact", head: true })
  .eq("user_id", userId)
  .not("recipe_id", "is", null);

// Formater la date de création
const formatDate = (dateString?: string) => {
  if (!dateString) return "Non disponible";
  const date = new Date(dateString);
  return date.toLocaleDateString("fr-FR", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

const roleLabel = 
  (userWithRole.role || userWithRole.user_role) === "admin" ? "Administrateur" :
  (userWithRole.role || userWithRole.user_role) === "premium" ? "Premium" :
  "Gratuit";

const roleColor = 
  (userWithRole.role || userWithRole.user_role) === "admin" ? "bg-purple-100 text-purple-700 border-purple-200" :
  (userWithRole.role || userWithRole.user_role) === "premium" ? "bg-yellow-100 text-yellow-700 border-yellow-200" :
  "bg-gray-100 text-gray-700 border-gray-200";
---

<Layout title="Mon compte">
  <div class="min-h-screen bg-gradient-to-br from-sage-50/30 via-sage-50/20 to-slate-50 pb-20">
    <div class="max-w-4xl mx-auto px-4 py-8 sm:py-12">
      <!-- En-tête -->
      <div class="mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-2">Mon compte</h1>
        <p class="text-slate-600">Gérez vos informations et préférences</p>
      </div>

      <!-- Informations utilisateur -->
      <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-6">
        <div class="flex items-start gap-4 mb-6">
          <div class={`w-16 h-16 rounded-xl flex items-center justify-center text-2xl ${
            (userWithRole.role || userWithRole.user_role) === 'admin' ? 'bg-purple-100 text-purple-600' :
            (userWithRole.role || userWithRole.user_role) === 'premium' ? 'bg-yellow-100 text-yellow-600' :
            'bg-gray-100 text-gray-600'
          }`}>
            <i class="fas fa-user"></i>
          </div>
          <div class="flex-1">
            <h2 class="text-xl font-bold text-slate-900 mb-1">Informations personnelles</h2>
            <p class="text-sm text-slate-500">Vos données de compte</p>
          </div>
        </div>

        <div class="space-y-4">
          <!-- Email -->
          <div class="border-b border-gray-100 pb-4">
            <label class="block text-sm font-medium text-slate-500 mb-1">Email</label>
            <p class="text-base text-slate-900">{userWithRole.email || profile?.email || "Non disponible"}</p>
          </div>

          <!-- Statut -->
          <div class="border-b border-gray-100 pb-4">
            <label class="block text-sm font-medium text-slate-500 mb-2">Statut</label>
            <span class={`inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold border ${roleColor}`}>
              {roleLabel}
            </span>
          </div>

          <!-- Date de création -->
          <div>
            <label class="block text-sm font-medium text-slate-500 mb-1">Membre depuis</label>
            <p class="text-base text-slate-900">
              {formatDate(profile?.created_at || userWithRole.created_at)}
            </p>
          </div>
        </div>
      </div>

      <!-- Changement de mot de passe -->
      <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-6">
        <h2 class="text-xl font-bold text-slate-900 mb-4">Changer le mot de passe</h2>
        <form id="change-password-form" class="space-y-4">
          <div>
            <label for="current-password" class="block text-sm font-medium text-slate-700 mb-2">
              Mot de passe actuel
            </label>
            <input
              type="password"
              id="current-password"
              name="currentPassword"
              required
              class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sage-300 focus:border-transparent outline-none transition"
              placeholder="Entrez votre mot de passe actuel"
            />
          </div>

          <div>
            <label for="new-password" class="block text-sm font-medium text-slate-700 mb-2">
              Nouveau mot de passe
            </label>
            <input
              type="password"
              id="new-password"
              name="newPassword"
              required
              minlength="6"
              class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sage-300 focus:border-transparent outline-none transition"
              placeholder="Entrez votre nouveau mot de passe (min. 6 caractères)"
            />
          </div>

          <div>
            <label for="confirm-password" class="block text-sm font-medium text-slate-700 mb-2">
              Confirmer le nouveau mot de passe
            </label>
            <input
              type="password"
              id="confirm-password"
              name="confirmPassword"
              required
              minlength="6"
              class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sage-300 focus:border-transparent outline-none transition"
              placeholder="Confirmez votre nouveau mot de passe"
            />
          </div>

          <div id="password-error" class="hidden text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-3"></div>
          <div id="password-success" class="hidden text-sm text-green-600 bg-green-50 border border-green-200 rounded-lg p-3"></div>

          <button
            type="submit"
            class="w-full px-4 py-3 bg-gradient-to-r from-sage-300 to-sage-500 text-white rounded-lg font-semibold hover:from-sage-300 hover:to-sage-600 transition shadow-lg hover:shadow-xl"
          >
            <i class="fas fa-key mr-2"></i>
            Modifier le mot de passe
          </button>
        </form>
      </div>

      <!-- Statistiques -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-lg bg-sage-100 text-sage-600 flex items-center justify-center">
              <i class="fas fa-book text-xl"></i>
            </div>
            <div>
              <p class="text-2xl font-bold text-slate-900">{recipesCount || 0}</p>
              <p class="text-sm text-slate-500">Recettes créées</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-lg bg-sage-100 text-sage-600 flex items-center justify-center">
              <i class="fas fa-calendar text-xl"></i>
            </div>
            <div>
              <p class="text-2xl font-bold text-slate-900">{planningCount || 0}</p>
              <p class="text-sm text-slate-500">Recettes planifiées</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-6">
        <h2 class="text-xl font-bold text-slate-900 mb-4">Actions</h2>
        <div class="space-y-3">
          <a
            href="/recipes"
            class="block w-full px-4 py-3 bg-gradient-to-r from-sage-300 to-sage-500 text-white rounded-lg font-semibold text-center hover:from-sage-300 hover:to-sage-600 transition shadow-lg hover:shadow-xl"
          >
            <i class="fas fa-book mr-2"></i>
            Voir mes recettes
          </a>
          
          <a
            href="/planning"
            class="block w-full px-4 py-3 bg-white border-2 border-slate-200 text-slate-700 rounded-lg font-semibold text-center hover:bg-slate-50 transition"
          >
            <i class="fas fa-calendar mr-2"></i>
            Voir mon planning
          </a>

          <form method="post" action="/api/auth/logout" class="w-full">
            <button
              type="submit"
              class="block w-full px-4 py-3 bg-white border-2 border-red-200 text-red-600 rounded-lg font-semibold text-center hover:bg-red-50 transition"
            >
              <i class="fas fa-sign-out-alt mr-2"></i>
              Déconnexion
            </button>
          </form>
        </div>
      </div>

      <!-- Zone de danger - Suppression de compte -->
      <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 border-2 border-red-200">
        <button
          id="delete-account-button"
          type="button"
          class="w-full px-4 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition shadow-lg hover:shadow-xl"
        >
          <i class="fas fa-trash-alt mr-2"></i>
          Supprimer mon compte
        </button>
        <div id="delete-error" class="hidden text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-3 mt-4"></div>
        <p class="text-sm text-slate-600 mt-2">
          La suppression de votre compte est définitive et irréversible. Toutes vos données seront supprimées.
        </p>
      </div>
    </div>
  </div>
</Layout>

<script>
  const changePasswordForm = document.getElementById("change-password-form") as HTMLFormElement | null;
  const errorDiv = document.getElementById("password-error");
  const successDiv = document.getElementById("password-success");

  if (changePasswordForm && errorDiv && successDiv) {
    changePasswordForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Masquer les messages précédents
      errorDiv.classList.add("hidden");
      successDiv.classList.add("hidden");

      const formData = new FormData(changePasswordForm);
      const currentPassword = formData.get("currentPassword");
      const newPassword = formData.get("newPassword") as string | null;
      const confirmPassword = formData.get("confirmPassword");

      // Validation côté client
      if (newPassword !== confirmPassword) {
        errorDiv.textContent = "Les nouveaux mots de passe ne correspondent pas";
        errorDiv.classList.remove("hidden");
        return;
      }

      if (!newPassword || newPassword.length < 6) {
        errorDiv.textContent = "Le nouveau mot de passe doit contenir au moins 6 caractères";
        errorDiv.classList.remove("hidden");
        return;
      }

      // Désactiver le bouton pendant la requête
      const submitButton = changePasswordForm.querySelector('button[type="submit"]') as HTMLButtonElement | null;
      if (!submitButton) return;
      
      const originalButtonText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Modification...';

      try {
        const response = await fetch("/api/auth/change-password", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            currentPassword,
            newPassword,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          errorDiv.textContent = data.error || "Une erreur est survenue";
          errorDiv.classList.remove("hidden");
        } else {
          successDiv.textContent = data.message || "Mot de passe modifié avec succès";
          successDiv.classList.remove("hidden");
          changePasswordForm.reset();
          
          // Masquer le message de succès après 5 secondes
          setTimeout(() => {
            successDiv.classList.add("hidden");
          }, 5000);
        }
      } catch (error) {
        errorDiv.textContent = "Une erreur est survenue. Veuillez réessayer.";
        errorDiv.classList.remove("hidden");
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.innerHTML = originalButtonText;
        }
      }
    });
  }

  // Gestion de la suppression de compte
  const deleteAccountButton = document.getElementById("delete-account-button") as HTMLButtonElement | null;
  const deleteErrorDiv = document.getElementById("delete-error");

  if (deleteAccountButton && deleteErrorDiv) {
    deleteAccountButton.addEventListener("click", async () => {
      // Afficher une alerte de confirmation
      const confirmed = confirm(
        "⚠️ ATTENTION : Cette action est irréversible !\n\n" +
        "La suppression de votre compte entraînera :\n" +
        "• La suppression de toutes vos recettes\n" +
        "• La suppression de votre planning\n" +
        "• La suppression de toutes vos données\n\n" +
        "Êtes-vous sûr de vouloir supprimer votre compte ?\n\n" +
        "Tapez 'SUPPRIMER' dans la prochaine boîte de dialogue pour confirmer."
      );

      if (!confirmed) {
        return;
      }

      // Demander une confirmation supplémentaire avec un mot-clé
      const confirmation = prompt(
        "Pour confirmer la suppression, veuillez taper 'SUPPRIMER' (en majuscules) :"
      );

      if (confirmation !== "SUPPRIMER") {
        deleteErrorDiv.textContent = "Suppression annulée. Le mot de confirmation ne correspond pas.";
        deleteErrorDiv.classList.remove("hidden");
        setTimeout(() => {
          deleteErrorDiv.classList.add("hidden");
        }, 5000);
        return;
      }

      // Masquer les messages précédents
      deleteErrorDiv.classList.add("hidden");

      // Désactiver le bouton pendant la requête
      deleteAccountButton.disabled = true;
      const originalText = deleteAccountButton.innerHTML;
      deleteAccountButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Suppression en cours...';

      try {
        const response = await fetch("/api/delete-account", {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        });

        let data;
        try {
          data = await response.json();
        } catch (jsonError) {
          // Si la réponse n'est pas du JSON, c'est probablement une erreur serveur
          const text = await response.text();
          console.error("Erreur lors du parsing de la réponse:", text);
          deleteErrorDiv.textContent = `Erreur serveur (${response.status}): ${text || "Réponse invalide"}`;
          deleteErrorDiv.classList.remove("hidden");
          deleteAccountButton.disabled = false;
          deleteAccountButton.innerHTML = originalText;
          return;
        }

        if (!response.ok) {
          const errorMessage = data.error || data.details || "Une erreur est survenue lors de la suppression";
          deleteErrorDiv.textContent = errorMessage + (data.code ? ` (Code: ${data.code})` : "");
          deleteErrorDiv.classList.remove("hidden");
          deleteAccountButton.disabled = false;
          deleteAccountButton.innerHTML = originalText;
        } else {
          // Déconnecter l'utilisateur et rediriger vers la landing page
          // On fait d'abord une déconnexion pour nettoyer la session côté client
          try {
            await fetch("/api/auth/logout", {
              method: "POST",
            });
          } catch (logoutError) {
            // Ignorer les erreurs de déconnexion, on redirige quand même
            console.warn("Erreur lors de la déconnexion:", logoutError);
          }
          
          // Rediriger vers la landing page
          alert("Votre compte a été supprimé avec succès.");
          // Utiliser replace pour éviter que l'utilisateur puisse revenir en arrière
          window.location.replace("/");
        }
      } catch (error) {
        console.error("Erreur lors de la suppression:", error);
        deleteErrorDiv.textContent = `Une erreur est survenue: ${error instanceof Error ? error.message : "Erreur inconnue"}`;
        deleteErrorDiv.classList.remove("hidden");
        deleteAccountButton.disabled = false;
        deleteAccountButton.innerHTML = originalText;
      }
    });
  }
</script>

