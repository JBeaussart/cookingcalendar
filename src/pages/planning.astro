---
/* src/pages/planning.astro (planning) */
import Layout from "../layouts/Layout.astro";
import { supabase } from "../supabase";
import { getServerSession } from "../lib/auth";

// Vérifier si l'utilisateur est connecté et récupérer le client Supabase en un seul appel
const { user, supabase: authSupabase } = await getServerSession(Astro.request);

// Si non connecté, rediriger vers la page d'accueil
if (!user) {
  return Astro.redirect("/", 302);
}

// Type assertion pour user
type UserWithId = {
  id: string;
};
const userWithId = user as UserWithId;
const userId = userWithId.id;

// Type assertion pour le client Supabase
const authenticatedSupabase = (authSupabase || supabase) as typeof supabase;

const days = [
  "lundi",
  "mardi",
  "mercredi",
  "jeudi",
  "vendredi",
  "samedi",
  "dimanche",
];

// Lire planning (day = nom du jour, champ: recipe_id) - filtré par user_id
// Optimisation : utiliser une seule requête avec jointure si possible, sinon charger en parallèle
const { data: planningData } = await authenticatedSupabase
  .from("planning")
  .select("day, recipe_id")
  .eq("user_id", userId);

type PlanningItem = {
  day: string;
  recipe_id: string | null;
};
const planningMap = new Map(
  (planningData || []).map((p: PlanningItem) => [p.day, p.recipe_id || ""]),
);

// Charger les recettes référencées (une seule requête pour toutes)
const recipeIds = days.map((d) => planningMap.get(d) || "").filter(Boolean);
const recipesById = new Map();

if (recipeIds.length) {
  const { data: recipesData } = await authenticatedSupabase
    .from("recipes")
    .select("*")
    .in("id", recipeIds)
    .eq("user_id", userId);

  if (recipesData) {
    for (const recipe of recipesData) {
      recipesById.set(recipe.id, recipe);
    }
  }
}

const entries = days.map((day) => {
  const rid = planningMap.get(day) || "";
  return { day, recipe: rid ? (recipesById.get(rid) ?? null) : null };
});

// Fonction pour optimiser les images via wsrv.nl
function getOptimizedImageUrl(originalUrl: string | null | undefined, width = 400, quality = 75): string {
  if (!originalUrl || originalUrl.startsWith('/') || originalUrl.startsWith('./')) {
    return originalUrl || "/images/default-recipe.jpg";
  }
  const params = new URLSearchParams({
    url: originalUrl,
    w: width.toString(),
    h: Math.round(width * 0.75).toString(),
    fit: 'cover',
    q: quality.toString(),
    output: 'webp'
  });
  return `https://wsrv.nl/?${params.toString()}`;
}
---

<Layout title="Planning" user={user}>
  <div class="min-h-screen bg-gradient-to-br from-sage-50/30 via-sage-50/20 to-slate-50">
    <div class="mx-auto max-w-5xl px-4 py-12">
      <!-- Header -->
      <div class="mb-12 text-center">
        <h1 class="text-4xl font-bold text-slate-900 mb-2">Ma semaine</h1>
        <p class="text-slate-600">Planifiez vos repas en un clin d'œil</p>
      </div>

      <!-- Days Grid -->
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {
          entries.map(({ day, recipe }) => {
            const rawImg = recipe?.image && String(recipe.image).trim() ? recipe.image : "/images/default-recipe.jpg";
            const img = getOptimizedImageUrl(rawImg, 400, 75);
            return (
              <div
                class="group relative rounded-3xl bg-white shadow-lg shadow-slate-200/50 transition-all duration-300 hover:shadow-xl hover:shadow-slate-300/50 hover:scale-[1.02]"
                data-day={day}
                data-current-recipe-id={recipe ? recipe.id : ""}
              >
                {recipe ? (
                  <>
                    {/* Recipe Image Background */}
                    <div class="relative h-28 overflow-hidden rounded-t-3xl">
                      <img
                        src={img}
                        alt={recipe.title}
                        loading="lazy"
                        decoding="async"
                        class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110"
                      />
                      <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent" />

                      {/* Day Badge */}
                      <div class="absolute top-2 left-2">
                        <div class="rounded-full bg-white/95 backdrop-blur-sm px-3 py-1 shadow-lg">
                          <span class="text-xs font-bold capitalize text-slate-900">
                            {day}
                          </span>
                        </div>
                      </div>

                      {/* Recipe Title Overlay */}
                      <div class="absolute bottom-0 left-0 right-0 p-3">
                        <a
                          href={`/recipes/${recipe.id}`}
                          class="block text-base font-bold text-white drop-shadow-lg hover:text-sage-200 transition line-clamp-2"
                        >
                          {recipe.title}
                        </a>
                      </div>
                    </div>

                    {/* Actions Bar */}
                    <div class="flex items-center justify-between border-t border-slate-100 bg-slate-50/50 px-3 py-2">
                      <a
                        href={`/recipes/${recipe.id}`}
                        class="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-sage-300 transition"
                      >
                        <svg
                          class="h-4 w-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                          />
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                          />
                        </svg>
                        Voir
                      </a>

                      <div class="flex items-center gap-1">
                        {/* Move button */}
                        <button
                          type="button"
                          title="Déplacer"
                          class="move-btn flex h-8 w-8 items-center justify-center rounded-lg text-slate-600 hover:bg-slate-200/50 transition"
                          data-day={day}
                          data-recipe-id={recipe.id}
                        >
                          <svg
                            class="h-4 w-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5"
                            />
                          </svg>
                        </button>

                        <form
                          method="post"
                          action={`/api/remove-recipe?day=${day}`}
                        >
                          <button
                            type="submit"
                            title="Retirer"
                            class="flex h-8 w-8 items-center justify-center rounded-lg text-slate-600 hover:bg-red-50 hover:text-red-600 transition"
                          >
                            <svg
                              class="h-4 w-4"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"
                              />
                            </svg>
                          </button>
                        </form>
                      </div>
                    </div>
                  </>
                ) : (
                  <>
                    {/* Empty state - just the image area */}
                    <a href={`/recipes?day=${day}`} class="block">
                      <div class="relative h-28 overflow-hidden rounded-3xl bg-gradient-to-br from-slate-100 to-slate-200 transition hover:from-slate-200 hover:to-slate-300">
                        {/* Day Badge */}
                        <div class="absolute top-2 left-2">
                          <div class="rounded-full bg-white/95 backdrop-blur-sm px-3 py-1 shadow-lg">
                            <span class="text-xs font-bold capitalize text-slate-900">
                              {day}
                            </span>
                          </div>
                        </div>

                        {/* Centered Add Icon */}
                        <div class="absolute inset-0 flex items-center justify-center">
                          <div class="flex h-12 w-12 items-center justify-center rounded-full bg-gradient-to-r from-sage-300 to-sage-500 text-white shadow-lg shadow-sage-300/30 transition-all hover:from-sage-300 hover:to-sage-600 hover:scale-110">
                            <svg
                              class="h-6 w-6"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2.5"
                                d="M12 4v16m8-8H4"
                              />
                            </svg>
                          </div>
                        </div>
                      </div>
                    </a>
                  </>
                )}
              </div>
            );
          })
        }
      </div>

      {/* Clear Planning Button */}
      <div class="mt-12 pb-16 sm:pb-0 text-center">
        <form method="post" action="/api/clear-planning" class="inline-block">
          <button
            type="submit"
            class="rounded-full bg-slate-900 px-6 py-3 text-sm font-semibold text-white shadow-lg transition hover:bg-slate-800 hover:shadow-xl"
            title="Réinitialiser le planning"
          >
            Réinitialiser le planning
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Dropdown menu container (will be populated by JS) -->
  <div
    id="move-dropdown"
    class="hidden fixed w-40 rounded-xl border border-slate-200 bg-white shadow-2xl z-[9999]"
  >
  </div>

  <script type="module" define:vars={{ days, entries }}>
    const initMoveDropdowns = () => {
      const moveButtons = document.querySelectorAll(".move-btn");
      const dropdown = document.getElementById("move-dropdown");
      let currentButton = null;

      const closeDropdown = () => {
        dropdown.classList.add("hidden");
        currentButton = null;
      };

      const showDropdown = (btn) => {
        const fromDay = btn.dataset.day;
        const recipeId = btn.dataset.recipeId;

        // Build dropdown content
        const dayOptions = days
          .map((targetDay) => {
            const targetEntry = entries.find((e) => e.day === targetDay);
            const hasRecipe = targetEntry?.recipe != null;
            const isCurrentDay = targetDay === fromDay;
            const disabled = isCurrentDay || hasRecipe;

            return `
            <button
              type="button"
              class="move-option w-full px-3 py-2 text-left text-sm transition ${
                disabled
                  ? "text-slate-400 cursor-not-allowed"
                  : "text-slate-700 hover:bg-slate-100"
              }"
              data-target-day="${targetDay}"
              data-from-day="${fromDay}"
              data-recipe-id="${recipeId}"
              ${disabled ? "disabled" : ""}
            >
              <span class="capitalize">${targetDay}</span>
              ${isCurrentDay ? '<span class="ml-2 text-xs text-slate-400">(actuel)</span>' : ""}
              ${!isCurrentDay && hasRecipe ? '<span class="ml-2 text-xs text-slate-400">(occupé)</span>' : ""}
            </button>
          `;
          })
          .join("");

        dropdown.innerHTML = `<div class="py-1.5">${dayOptions}</div>`;

        // Position dropdown
        const btnRect = btn.getBoundingClientRect();
        const dropdownHeight = 250; // Approximate
        const spaceBelow = window.innerHeight - btnRect.bottom;

        dropdown.style.left = `${btnRect.right - 160}px`; // 160px = w-40

        if (spaceBelow >= dropdownHeight) {
          dropdown.style.top = `${btnRect.bottom + 4}px`;
          dropdown.style.bottom = "auto";
        } else {
          dropdown.style.bottom = `${window.innerHeight - btnRect.top + 4}px`;
          dropdown.style.top = "auto";
        }

        dropdown.classList.remove("hidden");
        currentButton = btn;

        // Add click handlers to options
        dropdown.querySelectorAll(".move-option").forEach((option) => {
          option.addEventListener("click", async () => {
            if (option.disabled) return;

            const targetDay = option.dataset.targetDay;
            const fromDay = option.dataset.fromDay;
            const recipeId = option.dataset.recipeId;

            option.classList.add("opacity-60");
            option.disabled = true;

            try {
              const res = await fetch("/api/move-recipe", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  fromDay,
                  toDay: targetDay,
                  recipeId,
                  replaceWith: null,
                }),
              });

              if (!res.ok) throw new Error("Move failed");
              window.location.reload();
            } catch (err) {
              console.error("Déplacement impossible:", err);
              alert("Impossible de déplacer la recette. Merci de réessayer.");
              option.classList.remove("opacity-60");
              option.disabled = false;
            }
          });
        });
      };

      moveButtons.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (currentButton === btn) {
            closeDropdown();
          } else {
            showDropdown(btn);
          }
        });
      });

      document.addEventListener("click", (e) => {
        if (
          !e.target.closest(".move-btn") &&
          !e.target.closest("#move-dropdown")
        ) {
          closeDropdown();
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeDropdown();
        }
      });
    };

    if (document.readyState === "loading") {
      document.addEventListener("astro:page-load", initMoveDropdowns, {
        once: true,
      });
    } else {
      initMoveDropdowns();
    }
  </script>
</Layout>

